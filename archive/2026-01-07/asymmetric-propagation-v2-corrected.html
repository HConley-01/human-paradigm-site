<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asymmetric Propagation Law Simulator - NiCE Framework</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #0a0f1a;
      color: #e8edf4;
    }
    .serif { font-family: 'Fraunces', serif; }
    .glass-card {
      background: rgba(20, 30, 48, 0.6);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(100, 130, 180, 0.2);
    }
    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: rgba(100, 130, 180, 0.3);
      outline: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #3b82f6;
      cursor: pointer;
    }
    input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #3b82f6;
      cursor: pointer;
      border: none;
    }
    .level-bar {
      transition: all 0.3s ease;
    }
    .cascade-arrow {
      animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }
    .intervention-active {
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
    }
  </style>
</head>
<body class="min-h-screen">
  <!-- Navigation -->
  <nav class="glass-card border-b">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      <a href="/" class="flex items-center gap-2 hover:opacity-80 transition-opacity">
        <span class="text-2xl font-bold serif">NiCE Framework</span>
      </a>
      <div class="flex gap-6">
        <a href="/" class="text-gray-400 hover:text-white transition-colors">Home</a>
        <a href="/interactive-lab.html" class="text-gray-400 hover:text-white transition-colors">Interactive Lab</a>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="max-w-6xl mx-auto px-6 py-12">
    <div class="mb-8">
      <a href="/interactive-lab.html" class="inline-flex items-center gap-2 text-blue-400 hover:text-blue-300 mb-4">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        Back to Interactive Lab
      </a>
      <h1 class="text-4xl md:text-5xl font-bold serif mb-4">The Asymmetric Propagation Law</h1>
      <p class="text-xl text-gray-400 mb-4">
        <strong>The Claim:</strong> Dysfunction propagates automatically across N-C-E levels; improvement propagates only conditionally.
      </p>
      <div class="glass-card p-4 rounded-lg border border-yellow-500/30 bg-yellow-500/5">
        <p class="text-yellow-200 text-sm">
          This principle explains civilizational drift, institutional decay, reform failure, and why good intentions systematically fail—without requiring conspiracy, stupidity, or moral decline.
        </p>
      </div>
    </div>

    <!-- Thermodynamic Foundation -->
    <div class="glass-card p-6 rounded-lg mb-8">
      <h2 class="text-xl font-bold serif mb-4">The Thermodynamic Foundation</h2>
      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <p class="text-gray-300 mb-4">
            <strong>Second Law of Thermodynamics:</strong> Entropy (disorder) increases spontaneously unless energy is continuously input.
          </p>
          <ul class="space-y-2 text-sm text-gray-400">
            <li>• <strong>Dysfunction</strong> = Higher entropy state (disorder)</li>
            <li>• <strong>Function</strong> = Lower entropy state (order)</li>
            <li>• <strong>Natural direction:</strong> Toward disorder</li>
            <li>• <strong>Maintaining order:</strong> Requires continuous energy</li>
          </ul>
        </div>
        <div class="glass-card p-4 rounded bg-blue-500/10 border border-blue-500/30">
          <p class="text-blue-200 text-sm mb-2"><strong>This is not metaphor—it is the actual mechanism:</strong></p>
          <div class="space-y-2 text-sm">
            <div class="flex items-center gap-2">
              <span class="text-red-400">Order → Disorder:</span>
              <span class="text-gray-300">Automatic (thermodynamically downhill)</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-emerald-400">Disorder → Order:</span>
              <span class="text-gray-300">Requires work (thermodynamically uphill)</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Interactive Simulator -->
    <div class="glass-card p-8 rounded-lg mb-8">
      <h2 class="text-2xl font-bold serif mb-2">Interactive N-C-E Cascade Simulator</h2>
      <p class="text-gray-400 mb-6">Watch how a single perturbation cascades through Nature, Consciousness, and Environment levels over time.</p>
      
      <!-- System Health Meters -->
      <div class="grid md:grid-cols-3 gap-6 mb-8">
        <!-- Nature (N) -->
        <div class="glass-card p-4 rounded">
          <div class="flex items-center justify-between mb-2">
            <span class="font-bold text-blue-400">Nature (N)</span>
            <span id="nValue" class="font-mono">100%</span>
          </div>
          <div class="h-4 bg-gray-700 rounded overflow-hidden mb-2">
            <div id="nBar" class="level-bar h-full bg-blue-500 rounded" style="width: 100%"></div>
          </div>
          <p class="text-xs text-gray-400">Faculty count, health, capacity, productivity</p>
        </div>

        <!-- Consciousness (C) -->
        <div class="glass-card p-4 rounded">
          <div class="flex items-center justify-between mb-2">
            <span class="font-bold text-emerald-400">Consciousness (C)</span>
            <span id="cValue" class="font-mono">100%</span>
          </div>
          <div class="h-4 bg-gray-700 rounded overflow-hidden mb-2">
            <div id="cBar" class="level-bar h-full bg-emerald-500 rounded" style="width: 100%"></div>
          </div>
          <p class="text-xs text-gray-400">Morale, collective efficacy, culture, hope</p>
        </div>

        <!-- Environment (E) -->
        <div class="glass-card p-4 rounded">
          <div class="flex items-center justify-between mb-2">
            <span class="font-bold text-purple-400">Environment (E)</span>
            <span id="eValue" class="font-mono">100%</span>
          </div>
          <div class="h-4 bg-gray-700 rounded overflow-hidden mb-2">
            <div id="eBar" class="level-bar h-full bg-purple-500 rounded" style="width: 100%"></div>
          </div>
          <p class="text-xs text-gray-400">Budget, reputation, resources, infrastructure</p>
        </div>
      </div>

      <!-- Cascade Visualization -->
      <div class="flex justify-center items-center gap-4 mb-8 text-sm">
        <div id="cascadeN" class="px-3 py-1 rounded bg-blue-500/20 text-blue-300">N</div>
        <div class="cascade-arrow text-red-400">→</div>
        <div id="cascadeC" class="px-3 py-1 rounded bg-emerald-500/20 text-emerald-300">C</div>
        <div class="cascade-arrow text-red-400">→</div>
        <div id="cascadeE" class="px-3 py-1 rounded bg-purple-500/20 text-purple-300">E</div>
        <div class="cascade-arrow text-red-400">→</div>
        <div class="px-3 py-1 rounded bg-blue-500/20 text-blue-300">N</div>
        <span class="text-gray-500 ml-2">(feedback loop)</span>
      </div>

      <!-- Timeline Display -->
      <div class="glass-card p-4 rounded mb-6">
        <div class="flex justify-between items-center mb-2">
          <span class="font-semibold">Year: <span id="yearDisplay" class="text-blue-400 font-mono">0</span></span>
          <span id="phaseDisplay" class="text-sm text-gray-400">Healthy Equilibrium</span>
        </div>
        <div id="narrative" class="text-sm text-gray-300 min-h-[60px]">
          System at healthy equilibrium. 20 faculty, strong morale, adequate resources.
        </div>
      </div>

      <!-- Controls -->
      <div class="flex flex-wrap gap-4 mb-6">
        <button id="applyShock" class="px-4 py-2 bg-red-500 hover:bg-red-600 rounded transition-colors">
          Apply Budget Shock (-15%)
        </button>
        <button id="stepYear" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded transition-colors">
          Advance 1 Year
        </button>
        <button id="runSimulation" class="px-4 py-2 bg-purple-500 hover:bg-purple-600 rounded transition-colors">
          Run Full Cascade (6 years)
        </button>
        <button id="resetSimulation" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded transition-colors">
          Reset
        </button>
      </div>

      <!-- Intervention Panel -->
      <div class="border-t border-gray-700 pt-6">
        <h3 class="text-xl font-bold mb-4">Intervention Strategies</h3>
        <p class="text-sm text-gray-400 mb-4">Test different recovery approaches. Single-lever interventions provide temporary relief; multi-lever sustains recovery.</p>
        
        <div class="grid md:grid-cols-4 gap-4 mb-4">
          <button id="interventionE" class="intervention-btn p-4 glass-card rounded hover:bg-purple-500/10 transition-all text-left">
            <div class="font-bold text-purple-400 mb-1">E-Only</div>
            <div class="text-xs text-gray-400">Process improvement, better admin systems</div>
            <div class="text-xs text-gray-500 mt-2">Result: Brief bump, regression</div>
          </button>
          
          <button id="interventionC" class="intervention-btn p-4 glass-card rounded hover:bg-emerald-500/10 transition-all text-left">
            <div class="font-bold text-emerald-400 mb-1">C-Only</div>
            <div class="text-xs text-gray-400">Team-building, morale programs, pizza parties</div>
            <div class="text-xs text-gray-500 mt-2">Result: "Can't pizza-party out of this"</div>
          </button>
          
          <button id="interventionN" class="intervention-btn p-4 glass-card rounded hover:bg-blue-500/10 transition-all text-left">
            <div class="font-bold text-blue-400 mb-1">N-Only</div>
            <div class="text-xs text-gray-400">Temporary staff, one-time relief funding</div>
            <div class="text-xs text-gray-500 mt-2">Result: Improvement, then crash</div>
          </button>
          
          <button id="interventionAll" class="intervention-btn p-4 glass-card rounded hover:bg-yellow-500/10 transition-all text-left border border-yellow-500/30">
            <div class="font-bold text-yellow-400 mb-1">Multi-Lever</div>
            <div class="text-xs text-gray-400">Simultaneous N+C+E sustained intervention</div>
            <div class="text-xs text-yellow-300 mt-2">Result: Actual recovery possible</div>
          </button>
        </div>
        
        <div id="interventionResult" class="glass-card p-4 rounded text-sm text-gray-300 hidden">
          <!-- Intervention results will appear here -->
        </div>
      </div>
    </div>

    <!-- Detailed Metrics -->
    <div class="glass-card p-8 rounded-lg mb-8">
      <h2 class="text-2xl font-bold serif mb-4">System Metrics</h2>
      <p class="text-gray-400 mb-6">Based on the University Department 6-Year Cascade case study</p>
      
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="border-b border-gray-700">
            <tr class="text-left text-gray-400">
              <th class="pb-3">Metric</th>
              <th class="pb-3">Year 0</th>
              <th class="pb-3" id="currentYearHeader">Current</th>
              <th class="pb-3">Change</th>
            </tr>
          </thead>
          <tbody id="metricsTable" class="divide-y divide-gray-800">
            <!-- Metrics will be populated by JS -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- The Critical Observation -->
    <div class="glass-card p-8 rounded-lg mb-8 border border-red-500/30 bg-red-500/5">
      <h2 class="text-2xl font-bold serif mb-4 text-red-300">The Critical Observation: NO ONE INTENDED THIS</h2>
      <div class="grid md:grid-cols-2 gap-6">
        <ul class="space-y-2 text-gray-300">
          <li>• No malicious actors trying to destroy the department</li>
          <li>• No incompetent administrators (dealing with state-level crisis)</li>
          <li>• No lazy faculty (working harder than ever)</li>
          <li>• No evil plot</li>
        </ul>
        <div class="glass-card p-4 rounded bg-red-500/10">
          <p class="text-red-200 font-semibold mb-2">Pure thermodynamic cascade:</p>
          <p class="text-sm text-gray-300">
            Initial perturbation (budget cut) → Propagated through N-C-E system → Each degradation triggered cascading degradations → Positive feedback loops emerged → System spiraled to near-collapse
          </p>
        </div>
      </div>
    </div>

    <!-- Theory Section -->
    <div class="glass-card p-8 rounded-lg">
      <h2 class="text-2xl font-bold serif mb-4">Why Multi-Lever Recovery Works</h2>
      
      <div class="space-y-6">
        <div>
          <h3 class="font-bold text-lg mb-2">Multiple levers hold system in improved configuration:</h3>
          <ul class="text-sm text-gray-300 space-y-1 ml-4">
            <li>• E-resources enable N-capacity enable C-morale</li>
            <li>• C-morale enables N-productivity enables E-reputation</li>
            <li>• E-reputation enables E-recruitment enables N-quality</li>
            <li>• Positive feedback replaces negative</li>
          </ul>
        </div>

        <div>
          <h3 class="font-bold text-lg mb-2">Each improvement enables others (synergy):</h3>
          <ul class="text-sm text-gray-300 space-y-1 ml-4">
            <li>• Cannot improve morale without reducing workload (need resources)</li>
            <li>• Cannot improve productivity without better morale (need culture shift)</li>
            <li>• Cannot improve reputation without productivity (need all three)</li>
          </ul>
        </div>

        <div>
          <h3 class="font-bold text-lg mb-2">Harder for dysfunction to propagate back:</h3>
          <ul class="text-sm text-gray-300 space-y-1 ml-4">
            <li>• If one element slips (e.g., budget tight one year), others maintain stability</li>
            <li>• System has resilience through redundancy</li>
            <li>• Not dependent on single lever</li>
          </ul>
        </div>

        <div class="glass-card p-4 rounded border border-blue-500/30 bg-blue-500/10">
          <h3 class="font-bold text-blue-300 mb-2">The Testable Prediction:</h3>
          <p class="text-sm text-gray-300 mb-2">Compare systems receiving: Control (no intervention), Single-lever (E/N/C only), Multi-lever coordinated</p>
          <p class="text-sm text-blue-200"><strong>Hypothesis:</strong> Multi-lever shows faster recovery, larger magnitude, more durable improvement, lower relapse.</p>
          <p class="text-sm text-red-300 mt-2"><strong>Falsification:</strong> If multi-lever does not outperform single-lever → framework wrong.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // System state
    let state = {
      year: 0,
      N: 100, // Nature: faculty capacity, health, productivity
      C: 100, // Consciousness: morale, culture, efficacy
      E: 100, // Environment: budget, resources, reputation
      shocked: false,
      intervention: null,
      interventionYear: null,
      metrics: {
        faculty: 20,
        publications: 40,
        grants: 500, // in $K
        morale: 4.2, // out of 5
        studentSat: 4.2, // out of 5
        gradApps: 100, // indexed to 100
        retention: 90 // %
      }
    };

    const baselineMetrics = { ...state.metrics };

    // DOM elements
    const nBar = document.getElementById('nBar');
    const cBar = document.getElementById('cBar');
    const eBar = document.getElementById('eBar');
    const nValue = document.getElementById('nValue');
    const cValue = document.getElementById('cValue');
    const eValue = document.getElementById('eValue');
    const yearDisplay = document.getElementById('yearDisplay');
    const phaseDisplay = document.getElementById('phaseDisplay');
    const narrative = document.getElementById('narrative');
    const metricsTable = document.getElementById('metricsTable');
    const interventionResult = document.getElementById('interventionResult');

    // Year-by-year narratives from the case study
    const narratives = {
      0: {
        phase: "Healthy Equilibrium",
        text: "System at healthy equilibrium. 20 faculty members with diverse expertise, shared mission, positive morale. Budget $2M, Top 20 ranking, 50 graduate students with competitive admissions. This is a functional, sustainable system."
      },
      1: {
        phase: "Initial Perturbation",
        text: "State funding reduced 15%. Two retirements occur, hiring freeze implemented. Faculty: 20→18. Teaching load increases from 2.4 to 2.6 courses. First feelings of being stretched emerge. Publications drop to 35 (-12.5%). Two faculty receive outside offers. System still functional but stress emerging."
      },
      2: {
        phase: "Compounding Effects",
        text: "Two faculty accept outside offers. Faculty now 16 (-20% from Year 0). Teaching load: 3.1 courses/year. One faculty takes medical leave (stress-related). Complaining becomes normalized. Graduate students report advisors 'barely available.' Publications: 28 (-30%). The 'doom loop' begins forming."
      },
      3: {
        phase: "Accelerating Decline",
        text: "The doom loop activates. Can only hire weak junior candidates (top ones went elsewhere). 'This place is dying' narrative dominates. Faculty meetings become negative and blame-focused. Publications: 22 (-45%). Graduate applications down 40%. Dean threatens: 'Fix this or we'll restructure.' System in death spiral."
      },
      4: {
        phase: "Terminal Decline (Year 4)",
        text: "Three senior faculty retire early. Two mid-career faculty leave. Faculty: 12 remaining (40% reduction). Teaching load crushing: 4-5 courses/person. Research essentially stops. Graduate program near collapse: only 20 students. Budget: $1.3M (-35%). Talk of program closure begins."
      },
      5: {
        phase: "Terminal Decline (Year 5)",
        text: "Faculty: 12 (mostly junior or retirement-age, middle hollowed out). Publications: 15 (-62%). Grants: $150K (-70%). Graduate students: 20 (-60%). Morale: beyond repair. Rankings: Unranked (no longer competitive). Active discussions of program closure. NO ONE INTENDED THIS."
      },
      6: {
        phase: "Recovery Attempt",
        text: "New Department Chair appointed with mandate: 'Turn this around.' The question: What intervention strategy will work? Single-lever approaches (E-only, C-only, N-only) all fail. Only coordinated multi-lever intervention can achieve sustainable recovery."
      }
    };

    // Propagation rules (thermodynamic asymmetry)
    // KEY INSIGHT: Dysfunction propagates FROM unhealthy levels TO other levels
    // Single-lever intervention protects ONE level but others still cascade INTO it
    // Multi-lever stops cascade entirely and enables positive feedback
    
    function propagateDysfunction() {
      if (!state.shocked) return;
      
      // Determine which levels are "protected" by intervention
      const protectedLevels = {
        N: state.intervention === 'N',
        C: state.intervention === 'C', 
        E: state.intervention === 'E'
      };
      
      // Base degradation rates (thermodynamic drift toward disorder)
      const baseDrift = 3; // Entropy always increases slightly
      
      // CASCADE LOGIC:
      // Dysfunction flows: E problems → hurt N → hurt C → hurt E (feedback loop)
      // Single-lever: Protected level resists degradation but unprotected levels cascade
      // The cascade from unprotected levels eventually overwhelms the protected one
      
      // E→N cascade: Low resources strain capacity
      if (!protectedLevels.N) {
        const eStress = Math.max(0, 70 - state.E) / 70; // Stress when E < 70
        const degradation = baseDrift + (eStress * 12);
        state.N = Math.max(20, state.N - degradation);
      } else {
        // Even protected N slowly erodes if E and C are bad (can't hold forever)
        const externalPressure = ((100 - state.E) + (100 - state.C)) / 200;
        state.N = Math.max(20, state.N - (externalPressure * 5));
      }
      
      // N→C cascade: Overwork destroys morale
      if (!protectedLevels.C) {
        const nStress = Math.max(0, 70 - state.N) / 70;
        const degradation = baseDrift + (nStress * 15);
        state.C = Math.max(15, state.C - degradation);
      } else {
        // Even protected C erodes if N and E are bad (pizza parties don't fix overwork)
        const externalPressure = ((100 - state.N) + (100 - state.E)) / 200;
        state.C = Math.max(15, state.C - (externalPressure * 8));
      }
      
      // C→E cascade: Low morale → low productivity → reputation damage
      if (!protectedLevels.E) {
        const cStress = Math.max(0, 70 - state.C) / 70;
        const degradation = baseDrift + (cStress * 10);
        state.E = Math.max(25, state.E - degradation);
      } else {
        // Even protected E erodes if N and C are bad (good processes don't fix understaffing)
        const externalPressure = ((100 - state.N) + (100 - state.C)) / 200;
        state.E = Math.max(25, state.E - (externalPressure * 4));
      }
      
      updateMetrics();
    }

    function updateMetrics() {
      const nRatio = state.N / 100;
      const cRatio = state.C / 100;
      const eRatio = state.E / 100;
      
      state.metrics.faculty = Math.round(20 * nRatio);
      state.metrics.publications = Math.round(40 * nRatio * cRatio);
      state.metrics.grants = Math.round(500 * nRatio * cRatio * eRatio);
      state.metrics.morale = parseFloat((4.2 * cRatio).toFixed(1));
      state.metrics.studentSat = parseFloat((4.2 * cRatio * nRatio).toFixed(1));
      state.metrics.gradApps = Math.round(100 * eRatio * cRatio);
      state.metrics.retention = Math.round(90 * cRatio * nRatio);
    }

    function applyIntervention(type) {
      state.intervention = type;
      state.interventionYear = state.year;
      
      let result = "";
      
      switch(type) {
        case 'E':
          // E-only: Process improvement
          state.E = Math.min(100, state.E + 15);
          result = `<strong>E-Only Intervention Applied:</strong> Streamlined scheduling, better admin processes, renovated common areas. Budget: $50K.<br><br>
          <strong>Result After 1 Year:</strong> Morale gets brief bump (+0.2) then regresses. Productivity unchanged. One more faculty leaves.<br><br>
          <strong>Why it failed:</strong> Did not address actual problems. Still 12 faculty teaching same course load. Still overworked (N unchanged). Still demoralized about decline (C partially unchanged). <em>The ceiling: Better processes cannot fix too few people doing too much work.</em>`;
          break;
          
        case 'C':
          // C-only: Morale building
          state.C = Math.min(100, state.C + 20);
          result = `<strong>C-Only Intervention Applied:</strong> Team-building retreat ($10K), faculty recognition awards, social events, inspirational speeches, wellness programs.<br><br>
          <strong>Result After 1 Year:</strong> Morale initially +0.3, then back to baseline. Productivity unchanged. Two more faculty leave.<br><br>
          <strong>Why it failed:</strong> "You cannot pizza-party your way out of structural dysfunction." Recognition without reduced burden felt hollow. Social events felt like obligation when exhausted. <em>Faculty quote: "I don't need yoga; I need help teaching these classes."</em>`;
          break;
          
        case 'N':
          // N-only: Temporary relief
          state.N = Math.min(100, state.N + 35);
          state.C = Math.min(100, state.C + 15); // Temporary morale boost
          result = `<strong>N-Only Intervention Applied:</strong> One-time funding ($200K), hired 3 visiting faculty for 1 year, summer research stipends, course releases. Teaching load: 3.5→2.5 for one year.<br><br>
          <strong>Result After 1 Year:</strong> Morale significantly improved (+0.8). Publications up. No one left this year. <em>Looks promising...</em><br><br>
          <strong>Result After 2 Years (when funding ends):</strong> Teaching load back to 3.5+. Morale crashes back (or worse—"temporary hope" more demoralizing). Three faculty leave.<br><br>
          <strong>Why it ultimately failed:</strong> Temporary relief without structural change. When funding ended, reverted to dysfunction. Created false hope.`;
          break;
          
        case 'ALL':
          // Multi-lever: Simultaneous sustained intervention
          state.N = Math.min(100, state.N + 40);
          state.C = Math.min(100, state.C + 35);
          state.E = Math.min(100, state.E + 45);
          result = `<strong>Multi-Lever Intervention Applied:</strong><br><br>
          <strong>E-Intervention ($800K over 3 years):</strong> Stable budget increase $1.3M→$1.8M committed for 5 years. Hire 4 tenure-track + 2 visiting faculty. Repair building. Research infrastructure.<br><br>
          <strong>N-Intervention:</strong> Reduce teaching load immediately 3.5→2.5. Sabbaticals for burned-out seniors. Reduced service for juniors. Meaningful wellness support.<br><br>
          <strong>C-Intervention:</strong> Acknowledge past dysfunction explicitly. Involve faculty in strategic planning. Celebrate wins. Transparent communication. Rebuild community.<br><br>
          <strong>Year 1:</strong> New hires arrive (12→16). Teaching load reduced. "Things are actually changing." Publications: 18, Morale: +1.5 points.<br>
          <strong>Year 2:</strong> Sabbaticals completed. New faculty contributing. Better graduate cohort. Publications: 28. Word spreading: "Department turning around."<br>
          <strong>Year 3:</strong> Can recruit strong candidates. Faculty: 18. Publications: 38 (exceeds Year 0!). Grants: $520K. No departures. Positive feedback replaces negative.`;
          break;
      }
      
      interventionResult.innerHTML = result;
      interventionResult.classList.remove('hidden');
      updateMetrics(); // Update metrics to reflect intervention boost
      updateDisplay();
    }

    function updateDisplay() {
      // Update bars
      nBar.style.width = `${state.N}%`;
      cBar.style.width = `${state.C}%`;
      eBar.style.width = `${state.E}%`;
      
      // Color bars based on health
      nBar.className = `level-bar h-full rounded ${state.N > 60 ? 'bg-blue-500' : state.N > 30 ? 'bg-yellow-500' : 'bg-red-500'}`;
      cBar.className = `level-bar h-full rounded ${state.C > 60 ? 'bg-emerald-500' : state.C > 30 ? 'bg-yellow-500' : 'bg-red-500'}`;
      eBar.className = `level-bar h-full rounded ${state.E > 60 ? 'bg-purple-500' : state.E > 30 ? 'bg-yellow-500' : 'bg-red-500'}`;
      
      // Update values
      nValue.textContent = `${Math.round(state.N)}%`;
      cValue.textContent = `${Math.round(state.C)}%`;
      eValue.textContent = `${Math.round(state.E)}%`;
      
      // Update year and narrative
      yearDisplay.textContent = state.year;
      const yearNarrative = narratives[Math.min(state.year, 6)];
      phaseDisplay.textContent = yearNarrative.phase;
      narrative.textContent = yearNarrative.text;
      
      // Update metrics table
      renderMetricsTable();
    }

    function renderMetricsTable() {
      const metrics = [
        { name: 'Faculty', baseline: 20, current: state.metrics.faculty, unit: '' },
        { name: 'Publications/year', baseline: 40, current: state.metrics.publications, unit: '' },
        { name: 'Grant funding', baseline: 500, current: state.metrics.grants, unit: 'K' },
        { name: 'Faculty morale', baseline: 4.2, current: state.metrics.morale, unit: '/5' },
        { name: 'Student satisfaction', baseline: 4.2, current: state.metrics.studentSat, unit: '/5' },
        { name: 'Graduate applications', baseline: 100, current: state.metrics.gradApps, unit: ' (indexed)' },
        { name: 'Faculty retention', baseline: 90, current: state.metrics.retention, unit: '%' }
      ];
      
      document.getElementById('currentYearHeader').textContent = `Year ${state.year}`;
      
      metricsTable.innerHTML = metrics.map(m => {
        const change = m.current - m.baseline;
        const changePercent = ((m.current - m.baseline) / m.baseline * 100).toFixed(0);
        const changeColor = change >= 0 ? 'text-emerald-400' : 'text-red-400';
        const changeSign = change >= 0 ? '+' : '';
        
        return `
          <tr>
            <td class="py-3 font-medium">${m.name}</td>
            <td class="py-3 font-mono">${m.baseline}${m.unit}</td>
            <td class="py-3 font-mono">${m.current}${m.unit}</td>
            <td class="py-3 font-mono ${changeColor}">${changeSign}${changePercent}%</td>
          </tr>
        `;
      }).join('');
    }

    function reset() {
      state = {
        year: 0,
        N: 100,
        C: 100,
        E: 100,
        shocked: false,
        intervention: null,
        interventionYear: null,
        metrics: { ...baselineMetrics }
      };
      interventionResult.classList.add('hidden');
      document.querySelectorAll('.intervention-btn').forEach(btn => btn.classList.remove('intervention-active'));
      updateDisplay();
    }

    function applyShock() {
      if (state.shocked) return;
      state.shocked = true;
      state.E = 85; // 15% budget cut
      state.year = 1;
      propagateDysfunction();
      updateDisplay();
    }

    function stepYear() {
      if (state.year >= 6) return;
      state.year++;
      
      // Check if N-only intervention is wearing off (temporary funding ends)
      if (state.intervention === 'N' && state.year === state.interventionYear + 2) {
        state.N = Math.max(20, state.N - 30); // Visiting faculty leave
        state.C = Math.max(15, state.C - 25); // Hope crashes ("false hope" effect)
        state.intervention = null; // Intervention effect ends
      }
      
      // MULTI-LEVER: Stops cascade AND enables positive feedback
      if (state.intervention === 'ALL') {
        // Positive feedback loop: each level reinforces the others
        // This is the ONLY way to sustainably reverse the cascade
        const synergy = 1.2; // Mutual reinforcement bonus
        state.N = Math.min(100, state.N + (8 * synergy));
        state.C = Math.min(100, state.C + (10 * synergy));
        state.E = Math.min(100, state.E + (7 * synergy));
        updateMetrics();
      } else {
        // SINGLE-LEVER or NO INTERVENTION: Cascade continues
        // Single-lever slows ONE channel but others still degrade
        // Eventually the unprotected levels drag the protected one down
        propagateDysfunction();
      }
      
      updateDisplay();
    }

    async function runFullSimulation() {
      // Save current intervention if any (so user can test multi-lever on 6-year run)
      const savedIntervention = state.intervention;
      
      reset();
      await sleep(500);
      applyShock();
      
      // Restore intervention if one was selected before clicking "Run Full Cascade"
      if (savedIntervention) {
        state.intervention = savedIntervention;
        state.interventionYear = state.year; // Set intervention year to current year
        
        // CRITICAL: Apply initial boosts (reset wiped the boosts from applyIntervention)
        if (savedIntervention === 'ALL') {
          // Multi-lever: Boost all three levels
          state.N = Math.min(100, state.N + 40);
          state.C = Math.min(100, state.C + 35);
          state.E = Math.min(100, state.E + 45);
        } else if (savedIntervention === 'N') {
          // N-only: Temporary relief
          state.N = Math.min(100, state.N + 35);
          state.C = Math.min(100, state.C + 15);
        } else if (savedIntervention === 'C') {
          // C-only: Morale boost
          state.C = Math.min(100, state.C + 20);
        } else if (savedIntervention === 'E') {
          // E-only: Process improvement
          state.E = Math.min(100, state.E + 15);
        }
        
        updateMetrics();
        updateDisplay();
      }
      
      for (let i = 2; i <= 5; i++) {
        await sleep(800);
        stepYear();
      }
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Event listeners
    document.getElementById('applyShock').addEventListener('click', applyShock);
    document.getElementById('stepYear').addEventListener('click', stepYear);
    document.getElementById('runSimulation').addEventListener('click', runFullSimulation);
    document.getElementById('resetSimulation').addEventListener('click', reset);
    
    document.getElementById('interventionE').addEventListener('click', () => {
      document.querySelectorAll('.intervention-btn').forEach(btn => btn.classList.remove('intervention-active'));
      document.getElementById('interventionE').classList.add('intervention-active');
      applyIntervention('E');
    });
    
    document.getElementById('interventionC').addEventListener('click', () => {
      document.querySelectorAll('.intervention-btn').forEach(btn => btn.classList.remove('intervention-active'));
      document.getElementById('interventionC').classList.add('intervention-active');
      applyIntervention('C');
    });
    
    document.getElementById('interventionN').addEventListener('click', () => {
      document.querySelectorAll('.intervention-btn').forEach(btn => btn.classList.remove('intervention-active'));
      document.getElementById('interventionN').classList.add('intervention-active');
      applyIntervention('N');
    });
    
    document.getElementById('interventionAll').addEventListener('click', () => {
      document.querySelectorAll('.intervention-btn').forEach(btn => btn.classList.remove('intervention-active'));
      document.getElementById('interventionAll').classList.add('intervention-active');
      applyIntervention('ALL');
    });

    // Initialize
    updateDisplay();
  </script>
</body>
</html>
