<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Behavioral Sink Simulation | NiCE Framework</title>
    <meta name="description" content="Agent-based model of pathological behaviors emerging from complexity overload. Reinterprets Calhoun's mouse utopia experiments through the NiCE Framework.">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,wght@0,400;0,600;1,600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom, #0a0a0a 0%, #1a1a2e 100%);
            color: white;
            min-height: 100vh;
        }
        
        .serif {
            font-family: 'Fraunces', serif;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }
        
        #canvas {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            cursor: crosshair;
        }
        
        .control-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            -webkit-appearance: none;
        }
        
        .control-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
        
        .control-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
        
        .metric-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 8px;
            border-left: 3px solid;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .agent {
            position: absolute;
            border-radius: 50%;
            transition: all 0.1s;
        }
        
        .phase-indicator {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="glass-card border-b border-white/10 mb-8 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-4">
                    <a href="https://lernaean.net" title="Back to Lernaean Research">
                        <img src="/images/Lern_Logo2.png" alt="Lernaean Research" class="h-10 w-auto hover:opacity-80 transition-opacity">
                    </a>
                    <a href="/" class="flex items-center gap-2 text-white hover:text-blue-400 transition-colors">
                        <img src="/images/NiCE_Logo_New.png" alt="NiCE Framework Logo" class="h-10 w-auto">
                        <span class="text-xl font-semibold">NiCE Framework</span>
                    </a>
                </div>
                <div class="hidden md:flex gap-6 items-center">
                    <a href="/" class="text-gray-400 hover:text-white transition-colors">Home</a>
                    <a href="/nice-framework.html" class="text-gray-400 hover:text-white transition-colors">NiCE Synthesis</a>
                    <a href="/interactive-nice-explorer.html" class="text-gray-400 hover:text-white transition-colors">Interactive Explorer</a>
                    <a href="/interactive-lab.html" class="text-gray-400 hover:text-white transition-colors">Lab</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="inline-block px-3 py-1 bg-red-500/20 border border-red-500/30 rounded-full mb-4">
                <span class="text-red-300 text-sm font-medium">Advanced Simulation</span>
            </div>
            <h1 class="text-5xl font-bold mb-4 bg-gradient-to-r from-red-400 via-orange-400 to-yellow-400 bg-clip-text text-transparent serif">
                Behavioral Sink Simulation
            </h1>
            <p class="text-gray-300 text-lg max-w-4xl mb-4">
                Agent-based model of pathological behaviors emerging from symbolic complexity overload. Reinterprets Calhoun's mouse utopia experiments through the NiCE Framework: when symbolic structures decouple from biological needs and environmental capacity, populations exhibit reproductive collapse, violence, and social withdrawal.
            </p>
            
            <!-- Model Transparency Note -->
            <details class="max-w-4xl bg-blue-900/20 border border-blue-500/30 rounded-lg">
                <summary class="p-3 cursor-pointer text-blue-300 font-semibold hover:bg-blue-900/30 rounded-lg">
                    ‚ÑπÔ∏è Model Transparency: Empirical Grounding & Limitations
                </summary>
                <div class="p-4 pt-0 text-sm space-y-4">
                    <div>
                        <h4 class="text-green-400 font-semibold mb-2">‚úÖ Empirically Grounded Relationships:</h4>
                        <ul class="text-gray-300 space-y-1 ml-4">
                            <li>‚Ä¢ <strong>Overshoot Factor:</strong> Earth Overshoot Day data shows humanity at ~1.7x annual regeneration capacity</li>
                            <li>‚Ä¢ <strong>Abstraction-Extraction Link:</strong> Ecological footprint correlates with economic abstraction (US ~5x India per capita)</li>
                            <li>‚Ä¢ <strong>Bubble Magnitudes:</strong> Historical market divergences (Housing '08 ~40%, Dot-com ~60-70%) inform max sustainable divergence</li>
                            <li>‚Ä¢ <strong>Regeneration Damage:</strong> Topsoil loss ~1%/year under intensive agriculture; aquifer depletion rates documented</li>
                            <li>‚Ä¢ <strong>Hysteresis (Asymmetric Recovery):</strong> Ecological systems recover much slower than they degrade‚Äîwell documented</li>
                            <li>‚Ä¢ <strong>Cumulative Debt Compounding:</strong> Debt dynamics in financial systems show similar compound accumulation patterns</li>
                        </ul>
                    </div>
                    
                    <div>
                        <h4 class="text-yellow-400 font-semibold mb-2">‚ö†Ô∏è Structurally Sound But Coefficients Approximate:</h4>
                        <ul class="text-gray-300 space-y-1 ml-4">
                            <li>‚Ä¢ <strong>Rate Constants (0.1, 0.02, etc.):</strong> Calibrated for simulation visualization speed, not real-world time scales</li>
                            <li>‚Ä¢ <strong>Thresholds (1.5, 2.0, etc.):</strong> Based on ecological tipping point literature but simplified for model</li>
                            <li>‚Ä¢ <strong>Compound Factor:</strong> Conceptually correct (debt accelerates) but specific magnitude (√ó0.001) is approximate</li>
                            <li>‚Ä¢ <strong>Symbol Integrity Dynamics:</strong> Metaphorical representation of institutional trust collapse‚Äîtiming uncertain</li>
                        </ul>
                    </div>
                    
                    <div>
                        <h4 class="text-purple-400 font-semibold mb-2">üî¨ Model Purpose:</h4>
                        <p class="text-gray-300">
                            This simulation demonstrates <em>qualitative dynamics</em>‚Äîthe <strong>relationships</strong> between variables and 
                            <strong>system behaviors</strong> that emerge. It is <strong>not</strong> a predictive tool for specific timelines 
                            or magnitudes. Think of it like a climate model: the physics (relationships) are defensible; the parameters would 
                            require extensive calibration against historical data for quantitative predictions.
                        </p>
                    </div>
                    
                    <div class="p-3 bg-orange-900/20 rounded border border-orange-500/30">
                        <h4 class="text-orange-400 font-semibold mb-2">üêÅ Humans Are Not Mice ‚Äî But The Analogy May Understate The Problem:</h4>
                        <p class="text-gray-300 mb-2">
                            Calhoun's mice exhibited behavioral sink under conditions of <strong>actual</strong> unlimited resources. 
                            Their pathology emerged from real ecological abundance removing natural feedback loops.
                        </p>
                        <p class="text-gray-300 mb-2">
                            Humans face a potentially <em>worse</em> scenario: we can be made to <strong>perceive</strong> unlimited abundance 
                            (or scarcity) through <strong>symbolic abstractions with zero intrinsic ecological value</strong>. 
                            Numbers on screens, paper currencies, social media metrics‚Äînone fulfill actual biological needs, 
                            yet they can trigger the same "unlimited resources" perception in the brain that drove Calhoun's mice to extinction.
                        </p>
                        <p class="text-gray-300">
                            <strong>The contrast:</strong> Mice required <em>real</em> ecological manipulation. 
                            Humans can be ecologically decoupled through <em>pure symbol</em>‚Äîmaking the human case not weaker than 
                            the mouse analogy, but potentially more severe. We can have behavioral sink <em>while actual resources deplete</em>, 
                            because symbols maintain the illusion until catastrophic correction.
                        </p>
                    </div>
                    
                    <div class="p-3 bg-red-900/20 rounded border border-red-500/30">
                        <h4 class="text-red-400 font-semibold mb-2">üé≠ The Core Defect: You Cannot Consciously Choose Reality</h4>
                        <p class="text-gray-300 mb-2">
                            In ecological mode, <strong>perceived abundance is EMERGENT, not controllable</strong>. 
                            The "Resource" slider sets <em>actual</em> ecological carrying capacity (physical reality). 
                            <em>Perceived</em> abundance is then driven by symbolic abstraction‚Äî<strong>you cannot consciously override it</strong>.
                        </p>
                        <p class="text-gray-300 mb-2">
                            High abstraction doesn't just <em>maintain</em> false perception‚Äîit actively <strong>inflates</strong> perceived abundance 
                            toward fantasy ("innovation will save us", "the economy is growing", "my portfolio says I'm rich"). 
                            These narratives have <strong>zero intrinsic ecological value</strong>. They cannot regenerate soil, fill aquifers, 
                            or restore biodiversity. But they convince brains that abundance is unlimited.
                        </p>
                        <p class="text-gray-300">
                            <strong>The pathology:</strong> We irrationally believe we can rationalize fantasy narrative as reality. 
                            Symbols breed pathology ‚Üí disease ‚Üí collapse. Reality is real; fantastic narrative through irrational 
                            abstraction cannot be consciously corrected‚Äîonly catastrophic symbol failure forces recognition of actual conditions.
                        </p>
                    </div>
                    
                    <div class="p-3 bg-black/30 rounded border border-gray-600">
                        <p class="text-gray-400 text-xs">
                            <strong>For Researchers:</strong> Key empirical anchors documented in source code comments. 
                            Parameter sensitivity analysis and historical calibration would strengthen quantitative validity.
                            Current implementation prioritizes intuitive demonstration of feedback loop dynamics.
                        </p>
                    </div>
                </div>
            </details>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
            <!-- Main Simulation Canvas -->
            <div class="lg:col-span-3 glass-card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Population Dynamics</h2>
                    <div id="phase-display" class="phase-indicator bg-green-500/20 text-green-300">
                        Phase 1: Equilibrium
                    </div>
                </div>
                
                <canvas id="canvas" width="900" height="600"></canvas>
                
                <div class="mt-4 flex gap-3 flex-wrap">
                    <button id="startBtn" class="btn btn-primary">Start Simulation</button>
                    <button id="pauseBtn" class="btn btn-secondary">Pause</button>
                    <button id="resetBtn" class="btn btn-secondary">Reset</button>
                    <button id="interventionBtn" class="btn btn-secondary">Apply Intervention</button>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="space-y-4">
                <!-- Real-time Metrics -->
                <div class="glass-card p-4">
                    <h3 class="text-lg font-semibold mb-3">System Metrics</h3>
                    
                    <div class="metric-card border-blue-400 mb-3">
                        <div class="text-xs text-gray-400 mb-1">Population</div>
                        <div class="text-2xl font-bold" id="populationMetric">50</div>
                    </div>
                    
                    <div class="metric-card border-cyan-400 mb-3">
                        <div class="text-xs text-gray-400 mb-1">Actual Density</div>
                        <div class="text-2xl font-bold" id="actualDensityMetric">0.09</div>
                        <div class="text-xs text-gray-500">agents/1000px¬≤</div>
                    </div>
                    
                    <div class="metric-card border-green-400 mb-3">
                        <div class="text-xs text-gray-400 mb-1">Reproduction Rate</div>
                        <div class="text-2xl font-bold" id="reproductionMetric">100%</div>
                    </div>
                    
                    <div class="metric-card border-purple-400 mb-3">
                        <div class="text-xs text-gray-400 mb-1">Symbolic Complexity</div>
                        <div class="text-2xl font-bold" id="complexityMetric">Low</div>
                    </div>
                    
                    <div class="metric-card border-red-400 mb-3">
                        <div class="text-xs text-gray-400 mb-1">Pathology Index</div>
                        <div class="text-2xl font-bold" id="pathologyMetric">0%</div>
                    </div>
                    
                    <div class="metric-card border-yellow-400 mb-3">
                        <div class="text-xs text-gray-400 mb-1">Social Withdrawal</div>
                        <div class="text-2xl font-bold" id="withdrawalMetric">0%</div>
                    </div>
                </div>
                
                <!-- Ecological Dynamics Panel (shown when enabled) -->
                <div id="ecologicalPanel" class="glass-card p-4 hidden">
                    <h3 class="text-lg font-semibold mb-3 text-cyan-300">üåç Ecological State</h3>
                    
                    <div class="metric-card border-cyan-400 mb-3">
                        <div class="text-xs text-gray-400 mb-1">Earth Overshoot Factor</div>
                        <div class="text-2xl font-bold" id="overshootMetric">1.0x</div>
                        <div class="text-xs mt-1" id="overshootExplain">Sustainable</div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-gray-400">Actual Abundance</span>
                            <span class="text-cyan-300" id="actualAbundanceValue">100%</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div id="actualAbundanceBar" class="bg-cyan-500 h-2 rounded-full transition-all" style="width: 100%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-gray-400">Perceived Abundance</span>
                            <span class="text-green-300" id="perceivedAbundanceValue">100%</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div id="perceivedAbundanceBar" class="bg-green-500 h-2 rounded-full transition-all" style="width: 100%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-gray-400">Regeneration Capacity</span>
                            <span class="text-emerald-300" id="regenCapacityValue">100%</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div id="regenCapacityBar" class="bg-emerald-500 h-2 rounded-full transition-all" style="width: 100%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-gray-400">Symbol Integrity</span>
                            <span class="text-purple-300" id="symbolIntegrityValue">100%</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div id="symbolIntegrityBar" class="bg-purple-500 h-2 rounded-full transition-all" style="width: 100%"></div>
                        </div>
                    </div>
                    
                    <div class="p-2 rounded bg-black/30 text-xs" id="ecologicalDiagnosis">
                        <!-- Dynamic diagnosis -->
                    </div>
                </div>

                <!-- System Parameters -->
                <div class="glass-card p-4">
                    <h3 class="text-lg font-semibold mb-3">Parameters</h3>
                    
                    <div class="mb-4">
                        <div class="flex justify-between mb-2">
                            <label class="text-sm text-gray-300">Initial Population</label>
                            <span id="densityValue" class="text-sm font-mono text-blue-300">50</span>
                        </div>
                        <input type="range" id="densitySlider" class="control-slider" min="10" max="200" value="50">
                        <div class="text-xs text-gray-500 mt-1">Starting agent count (actual density calculated in real-time)</div>
                        <div id="densityEffect" class="text-xs text-gray-400 mt-1"></div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex justify-between mb-2">
                            <label id="resourceLabel" class="text-sm text-gray-300">Resource Abundance</label>
                            <span id="resourceValue" class="text-sm font-mono text-green-300">100%</span>
                        </div>
                        <input type="range" id="resourceSlider" class="control-slider" min="20" max="200" value="100">
                        <div id="resourceEffect" class="text-xs text-gray-400 mt-1"></div>
                        <div id="resourceModeNote" class="hidden text-xs text-cyan-400 mt-1 p-2 bg-cyan-900/20 rounded">
                            <strong>Ecological Mode:</strong> This sets ACTUAL carrying capacity (physical reality). 
                            <em>Perceived</em> abundance is EMERGENT from symbolic abstraction‚Äîyou cannot consciously control it. 
                            High abstraction will maintain/inflate perception even as actual depletes.
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex justify-between mb-2">
                            <label class="text-sm text-gray-300">Symbolic Abstraction</label>
                            <span id="symbolicValue" class="text-sm font-mono text-purple-300">1.0x</span>
                        </div>
                        <input type="range" id="symbolicSlider" class="control-slider" min="10" max="100" value="10">
                        <div id="symbolicEffect" class="text-xs text-gray-400 mt-1"></div>
                    </div>
                    
                    <!-- Friction is now CALCULATED, not a slider -->
                    <div class="p-3 bg-orange-900/20 border border-orange-500/30 rounded-lg">
                        <div class="flex justify-between mb-1">
                            <label class="text-sm text-orange-300 font-semibold">Effective Friction (emergent)</label>
                            <span id="frictionValue" class="text-sm font-mono text-orange-300">0.85</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2 mb-2">
                            <div id="frictionBar" class="bg-green-500 h-2 rounded-full transition-all" style="width: 85%"></div>
                        </div>
                        <div id="frictionEffect" class="text-xs text-gray-400"></div>
                        <div class="text-xs text-gray-500 mt-2 italic leading-relaxed">
                            <strong>Key insight:</strong> Friction is NOT independent‚Äîhigh abstraction <em>enables</em> low friction. 
                            You can't have "frictionless barter" but you CAN have "frictionless digital currency."
                        </div>
                    </div>
                    
                    <!-- Ecological Dynamics Toggle -->
                    <div class="mt-4 p-3 bg-red-900/20 border border-red-500/30 rounded-lg">
                        <div class="flex items-center gap-3 mb-2">
                            <input type="checkbox" id="ecologicalToggle" class="w-4 h-4 accent-red-500">
                            <label for="ecologicalToggle" class="text-sm text-red-300 font-semibold">
                                Enable Full Lifecycle (Ecological Collapse)
                            </label>
                        </div>
                        <div class="text-xs text-gray-400 mb-3">
                            Simulates divergence between PERCEIVED and ACTUAL abundance until terminal collapse
                        </div>
                        
                        <div id="ecologicalMetrics" class="space-y-2 hidden">
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-400">Perceived Abundance:</span>
                                <span id="perceivedAbundanceDisplay" class="text-blue-300 font-mono">100%</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-400">ACTUAL Abundance:</span>
                                <span id="actualAbundanceDisplay" class="text-green-300 font-mono">100%</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-400">Divergence:</span>
                                <span id="divergenceDisplay" class="text-yellow-300 font-mono">0</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-400">Extractive Debt:</span>
                                <span id="extractiveDebtDisplay" class="text-orange-300 font-mono">0</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-400">Symbol Integrity:</span>
                                <span id="symbolIntegrityDisplay" class="text-purple-300 font-mono">100%</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-400">Regen Capacity:</span>
                                <span id="regenCapacityDisplay" class="text-emerald-300 font-mono">100%</span>
                            </div>
                            <div id="collapseWarning" class="hidden mt-2 p-2 bg-red-500/30 rounded text-center">
                                <span class="text-red-200 font-bold text-xs">‚ö†Ô∏è SYMBOL COLLAPSE - FRICTION ‚Üí 100%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Diagnosis -->
                <div class="glass-card p-4">
                    <h3 class="text-lg font-semibold mb-3">System Diagnosis</h3>
                    <div id="systemDiagnosis" class="space-y-2 text-sm">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Scenario Presets -->
                <div class="glass-card p-4">
                    <h3 class="text-lg font-semibold mb-3">Scenarios</h3>
                    <div class="space-y-2">
                        <button class="w-full btn btn-secondary text-left text-sm p-3" onclick="loadScenario('sustainable')">
                            <div class="font-semibold text-green-400">‚úì Sustainable Community</div>
                            <div class="text-xs text-gray-400 mt-1">Low complexity + adequate resources = stable thriving</div>
                        </button>
                        <button class="w-full btn btn-secondary text-left text-sm p-3" onclick="loadScenario('scarcity-grounded')">
                            <div class="font-semibold text-blue-400">‚Ñπ Healthy Scarcity Response</div>
                            <div class="text-xs text-gray-400 mt-1">Low resources + low complexity = reality felt, natural adaptation</div>
                        </button>
                        <button class="w-full btn btn-secondary text-left text-sm p-3" onclick="loadScenario('crowded-stable')">
                            <div class="font-semibold text-green-400">‚úì Crowded But Stable</div>
                            <div class="text-xs text-gray-400 mt-1">HIGH density + LOW complexity = thriving (density ‚â† problem)</div>
                        </button>
                        <button class="w-full btn btn-secondary text-left text-sm p-3" onclick="loadScenario('modern')">
                            <div class="font-semibold text-yellow-400">‚ö† Modern Society</div>
                            <div class="text-xs text-gray-400 mt-1">Moderate complexity + some friction = chronic stress</div>
                        </button>
                        <button class="w-full btn btn-secondary text-left text-sm p-3" onclick="loadScenario('calhoun')">
                            <div class="font-semibold text-orange-400">‚ö† Universe 25</div>
                            <div class="text-xs text-gray-400 mt-1">Unlimited resources + high complexity + no friction = sink</div>
                        </button>
                        <button class="w-full btn btn-secondary text-left text-sm p-3" onclick="loadScenario('sparse-collapse')">
                            <div class="font-semibold text-red-400">‚úó Sparse But Collapsing</div>
                            <div class="text-xs text-gray-400 mt-1">LOW density + HIGH complexity = sink (proves it's symbolic!)</div>
                        </button>
                        <button class="w-full btn btn-secondary text-left text-sm p-3" onclick="loadScenario('social-media')">
                            <div class="font-semibold text-red-400">‚úó Digital Dystopia</div>
                            <div class="text-xs text-gray-400 mt-1">Extreme complexity + zero friction = rapid collapse</div>
                        </button>
                        <button class="w-full btn btn-secondary text-left text-sm p-3" onclick="loadScenario('insanity-bubble')">
                            <div class="font-semibold text-red-500">‚ò† Insanity Bubble (Full Lifecycle)</div>
                            <div class="text-xs text-gray-400 mt-1">Perceived abundance diverges from actual ‚Üí symbol collapse ‚Üí friction 100% ‚Üí extinction</div>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Behavioral Patterns Chart -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="glass-card p-6">
                <h3 class="text-xl font-semibold mb-4">Behavior Timeline</h3>
                <canvas id="timelineChart" width="500" height="300"></canvas>
            </div>
            
            <div class="glass-card p-6">
                <h3 class="text-xl font-semibold mb-4">Phase Progression</h3>
                <div class="space-y-4" id="phaseInfo">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Theoretical Framework -->
        <div class="glass-card p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4 serif">Theoretical Foundation</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="p-4 bg-black/30 rounded-lg">
                    <div class="text-blue-400 font-semibold mb-2">Nature (N)</div>
                    <p class="text-sm text-gray-300">
                        Biological needs: reproduction, territory, social bonding. When symbolic complexity exceeds biological capacity for integration, reproductive function collapses.
                    </p>
                </div>
                
                <div class="p-4 bg-black/30 rounded-lg">
                    <div class="text-green-400 font-semibold mb-2">Consciousness (C)</div>
                    <p class="text-sm text-gray-300">
                        Social hierarchies and status symbols. As symbolic structures decouple from reality, agents compete for meaningless markers, generating violence and withdrawal.
                    </p>
                </div>
                
                <div class="p-4 bg-black/30 rounded-lg">
                    <div class="text-purple-400 font-semibold mb-2">Environment (E)</div>
                    <p class="text-sm text-gray-300">
                        Physical and symbolic environment. Abundance removes natural constraints, creating frictionless space where pathological behaviors propagate without correction.
                    </p>
                </div>
            </div>
            
            <!-- The Core Mechanism -->
            <div class="mt-6 p-4 bg-purple-900/20 border border-purple-500/30 rounded-lg">
                <h3 class="font-semibold text-purple-300 mb-2">üß† The Neural Mechanism: Why Symbolic Complexity Causes Collapse</h3>
                <p class="text-sm text-gray-300 mb-3">
                    The human brain's reward circuitry evolved to respond to <strong>real ecological resources</strong>‚Äîfood, shelter, mates, social bonds. 
                    But the brain <strong>cannot distinguish</strong> between actual resources and <strong>symbolic representations</strong> of resources.
                </p>
                <p class="text-sm text-gray-300 mb-3">
                    <strong>High abstraction enables frictionless systems:</strong> You can't have "frictionless barter"‚Äîphysical exchange imposes unavoidable 
                    delays and costs. But digital currency <em>can</em> be frictionless because abstraction removes physical constraints. 
                    The abstraction level sets the <strong>floor</strong> on how low friction can go.
                </p>
                <p class="text-sm text-gray-300 mb-3">
                    When <strong>high abstraction + high abundance</strong> combine, friction approaches zero. The brain perceives this as 
                    <em>unlimited resources</em>‚Äîexactly like Calhoun's mice with their unlimited food and water. The symbolic complexity 
                    <strong>hides</strong> that nothing is tethered to ecological reality.
                </p>
                <p class="text-sm text-gray-300">
                    When the brain perceives unlimited resources, it shifts from <strong>biological imperatives</strong> (reproduction, genuine social bonding) 
                    to <strong>status competition</strong> (likes, followers, wealth accumulation). These status hierarchies become ends in themselves‚Äî
                    decoupled from any biological utility. Result: "beautiful ones" who groom endlessly, aggressive males fighting for meaningless territory, 
                    and universal reproductive collapse.
                </p>
            </div>
            
            <div class="mt-6 p-4 bg-red-900/20 border border-red-500/30 rounded-lg">
                <h3 class="font-semibold text-red-300 mb-2">Calhoun's Universe 25 Reinterpreted</h3>
                <p class="text-sm text-gray-300">
                    John B. Calhoun's mouse utopia experiments (1968-1972) are often misinterpreted as demonstrating that "overpopulation causes collapse." 
                    The NiCE Framework reveals the true mechanism: <strong>symbolic dysregulation, not density</strong>. Mice developed pathological 
                    social hierarchies (symbolic structures) that became decoupled from biological needs and environmental capacity. The unlimited 
                    resources removed all friction‚Äîno feedback loops corrected maladaptive behaviors. Result: reproductive collapse, violence, 
                    social withdrawal. <strong>Modern frictionless money creates identical conditions in the human brain.</strong>
                </p>
            </div>
            
            <!-- The Two Modes of Reproductive Decline -->
            <div class="mt-6 p-4 bg-gradient-to-r from-green-900/20 to-red-900/20 border border-amber-500/30 rounded-lg">
                <h3 class="font-semibold text-amber-300 mb-3">üß¨ The Evolutionary Core: Two Modes of Reproductive Decline</h3>
                
                <p class="text-sm text-gray-300 mb-4 p-3 bg-black/40 rounded border-l-2 border-amber-500/50">
                    <strong class="text-amber-300">On terminology:</strong> Mode 1 is labeled <span class="text-green-300 font-semibold">SANE</span> 
                    because its operative mechanics remain directly grounded in ecological reality‚Äîthe feedback loop between environment and behavior 
                    remains intact. Mode 2 is labeled <span class="text-red-300 font-semibold">INSANE</span> because behavior becomes untethered from 
                    operative reality, replaced by abstracted symbolic feedback (monetary value) that short-circuits the brain's evolved ecological 
                    sensitivity. The conviction that money possesses intrinsic survival value independent of‚Äîor superior to‚Äîactual ecological 
                    constraints constitutes a departure from rational engagement with reality. This aligns with operative legal definitions of insanity: 
                    <em>the inability to distinguish constructed fantasy from material reality when making consequential decisions</em>.
                </p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="p-3 bg-green-900/30 rounded border border-green-500/30">
                        <h4 class="font-semibold text-green-300 mb-2">Mode 1: Evolved Ecological Regulation (SANE)</h4>
                        <p class="text-sm text-gray-300 mb-2">
                            For millions of years, reproduction was <strong>directly tethered to ecological reality</strong>: 
                            available game, gathering yields, materials for shelter. The brain evolved exquisite sensitivity 
                            to these signals. Scarcity was the <em>normal</em> condition‚Äîrarely did genuine abundance persist.
                        </p>
                        <div class="text-xs text-gray-400 space-y-1">
                            <p>‚Ä¢ Ecology ‚Üí Perception ‚Üí Behavior (feedback loop intact)</p>
                            <p>‚Ä¢ Reproduction constrained by <em>real</em> resource limits</p>
                            <p>‚Ä¢ Behavioral sink rare/nonexistent‚Äîfriction from reality constant</p>
                            <p>‚Ä¢ <span class="text-green-300">Declining reproduction = healthy adaptive response</span></p>
                        </div>
                        <p class="text-xs text-amber-300 mt-2">
                            <strong>Key insight:</strong> Abundance wasn't evolved for because of its realistic improbability. 
                            The brain has no evolutionary "handler" for genuine, sustained abundance.
                        </p>
                    </div>
                    
                    <div class="p-3 bg-red-900/30 rounded border border-red-500/30">
                        <h4 class="font-semibold text-red-300 mb-2">Mode 2: Symbolic Short-Circuit (INSANE)</h4>
                        <p class="text-sm text-gray-300 mb-2">
                            Untethered abstraction <strong>short-circuits</strong> the evolved instinct. The rapid pace of 
                            cultural symbolic complexity‚Äîmoney, status metrics, digital representations‚Äîcreates signals 
                            the brain was never selected to distinguish from ecological reality.
                        </p>
                        <div class="text-xs text-gray-400 space-y-1">
                            <p>‚Ä¢ Symbol ‚Üí Perception ‚Üí Behavior (ecology bypassed)</p>
                            <p>‚Ä¢ Brain perceives symbolic abundance as <em>real</em> abundance</p>
                            <p>‚Ä¢ Frictionless systems enable pathological behavioral loops</p>
                            <p>‚Ä¢ <span class="text-red-300">Declining reproduction = pathological malfunction</span></p>
                        </div>
                        <p class="text-xs text-amber-300 mt-2">
                            <strong>The disease:</strong> Respect for the symbol outweighs respect for the substrate. 
                            The abstraction becomes preferred to ecological reality. Insanity captures individuals and systems.
                        </p>
                    </div>
                </div>
                
                <div class="text-sm text-gray-300 p-3 bg-black/30 rounded">
                    <p class="font-semibold text-amber-300 mb-2">Same Symptom, Opposite Causes:</p>
                    <p>Both modes produce declining reproduction‚Äîbut one is <strong>evolution working correctly</strong> 
                    (reality felt, constraint respected) while the other is <strong>evolution failing</strong> 
                    (symbol mistaken for reality, constraint invisible). The pathology isn't the symptom‚Äîit's the 
                    <em>relationship to ground</em>.</p>
                    <p class="mt-2 text-xs text-gray-400">
                        The brain evolved for Mode 1. It has no defense against Mode 2. When symbols create perceived 
                        abundance + frictionlessness, the brain applies its scarcity-evolved circuitry to a situation 
                        it was never designed to encounter. The result is behavioral sink‚Äînot from abundance itself, 
                        but from <strong>symbolic abundance untethered from ecological reality</strong>.
                    </p>
                </div>
            </div>
        </div>

        <!-- Intervention Strategies -->
        <div class="glass-card p-6">
            <h2 class="text-2xl font-bold mb-4 serif">Intervention Strategies</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="p-4 bg-black/30 rounded-lg border border-green-500/30">
                    <h4 class="font-semibold text-green-300 mb-2">‚úì Winning Strategies</h4>
                    <ul class="text-sm text-gray-300 space-y-2">
                        <li>‚Ä¢ <strong>Keep symbolic complexity low (1.0-2.0x):</strong> Low abstraction = high friction floor (reality unavoidable)</li>
                        <li>‚Ä¢ <strong>Understand friction is emergent:</strong> You can't "add friction" to a frictionless system‚Äîreduce abstraction instead</li>
                        <li>‚Ä¢ <strong>Tether symbols to physical reality:</strong> Money should require real production, status should require real action</li>
                        <li>‚Ä¢ <strong>Protect biological imperatives:</strong> Social structures should serve reproduction, not replace it</li>
                        <li>‚Ä¢ <strong>Interpret reproduction decline correctly:</strong> Declining birth rates can signal TWO things:
                            <ul class="ml-4 mt-1 text-xs text-gray-400 space-y-1">
                                <li>‚Üí <span class="text-red-300">PATHOLOGICAL:</span> High abstraction + perceived abundance ‚Üí behavioral sink (status replaces mating)</li>
                                <li>‚Üí <span class="text-green-300">HEALTHY:</span> Low abstraction + actual scarcity ‚Üí natural grounding response (reality felt, adaptive)</li>
                            </ul>
                            <span class="text-xs text-amber-300 mt-1 block">The KEY: Is the decline driven by FANTASY or REALITY?</span>
                        </li>
                    </ul>
                </div>
                
                <div class="p-4 bg-black/30 rounded-lg border border-red-500/30">
                    <h4 class="font-semibold text-red-300 mb-2">‚úó Losing Strategies (Path to Collapse)</h4>
                    <ul class="text-sm text-gray-300 space-y-2">
                        <li>‚Ä¢ <strong>High symbolic complexity (>4.0):</strong> Abstraction lowers friction floor, enabling pathology</li>
                        <li>‚Ä¢ <strong>Trying to "add friction" to abstract systems:</strong> Like adding speed bumps to the internet‚Äîthe abstraction bypasses it</li>
                        <li>‚Ä¢ <strong>Frictionless money + abundance:</strong> Creates "unlimited resource" perception in brain</li>
                        <li>‚Ä¢ <strong>Status competition replacing biology:</strong> Likes/followers/wealth become ends, not means</li>
                        <li>‚Ä¢ <strong>Technological acceleration:</strong> Removes friction faster than adaptation can occur</li>
                        <li>‚Ä¢ <strong>Misdiagnosing reproductive decline:</strong> Confusing healthy ecological response (grounded in reality) with pathological sink (floating in symbols). Both show declining births‚Äîonly one is adaptive.</li>
                    </ul>
                </div>
            </div>
            
            <!-- The Billionaire Parallel -->
            <div class="mt-4 p-4 bg-black/30 rounded-lg border border-purple-500/30">
                <h4 class="font-semibold text-purple-300 mb-2">üèõÔ∏è The Billionaire as Behavioral Sink Phenotype</h4>
                <p class="text-sm text-gray-300 mb-3">
                    In Calhoun's experiments, dominant males would <em>viciously defend territories containing nothing of survival value</em>. 
                    The territory had become pure symbol‚Äîthe fighting pure ritual. The biological circuit 
                    <span class="text-green-300">"territory ‚Üí resources ‚Üí reproduction"</span> collapsed into 
                    <span class="text-red-300">"territory ‚Üí territory"</span>.
                </p>
                <p class="text-sm text-gray-300 mb-3">
                    <strong>Billionaires are the human equivalent.</strong> Wealth beyond any possible consumption is <em>purely symbolic</em>. 
                    The 50th billion has zero marginal utility for survival or reproduction‚Äîit's a number on a screen, 
                    a score in a game that has replaced the game it was meant to track. The biological circuit 
                    <span class="text-green-300">"wealth ‚Üí resources ‚Üí reproduction"</span> becomes 
                    <span class="text-red-300">"wealth ‚Üí wealth"</span>.
                </p>
                <div class="text-xs text-gray-400 space-y-1">
                    <p>‚Ä¢ Calhoun's territorial males: Defended <em>empty space</em> as if it were food</p>
                    <p>‚Ä¢ Modern billionaires: Accumulate <em>unconsumed numbers</em> as if they were survival</p>
                    <p>‚Ä¢ Same pathology: Symbol became end, biological purpose forgotten</p>
                    <p>‚Ä¢ Key tell: Both show <strong>declining reproduction</strong> despite "winning" by their own metric</p>
                </div>
                <div class="text-xs text-gray-500 mt-3 p-2 bg-black/20 rounded border-l-2 border-purple-500/50">
                    <p class="text-purple-300 font-semibold mb-1">The "Exception" That Proves the Rule:</p>
                    <p>Some billionaires (e.g., Musk) do reproduce prolifically‚Äîbut examine the <em>process</em>:</p>
                    <p class="mt-1">‚Ä¢ Reproduction framed as <em>ideological project</em> ("civilization needs more people," "Mars colonization")</p>
                    <p>‚Ä¢ Mating dynamics show classic sink distortion: serial high-status partners, pair-bonding decoupled from reproduction</p>
                    <p>‚Ä¢ That we can <em>name</em> the exception proves how rare it is</p>
                    <p class="mt-1 text-amber-300">The output (children) occurs, but the process is abstracted‚Äîreproduction as <em>symbol</em> rather than <em>drive</em>.</p>
                    <p class="mt-2 text-cyan-300 font-semibold">The Systems-Thinker Escape Hatch?</p>
                    <p>Highly system-wired engineers may <em>see the bug</em>‚Äîrecognize the feedback loop, notice the missing constraint, consciously correct. 
                    But this raises a question: <span class="text-amber-300">if you need a <em>theory</em> about demographic collapse to reproduce, 
                    you're still operating in the symbolic layer.</span> The "fix" is itself abstract.</p>
                    <p class="mt-1">A subsistence farmer needs no meta-narrative to have children. The systems-thinker's correction, while functional, 
                    is <em>symbol correcting for symbol</em>‚Äîa patch on abstraction, not a return to ground.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // BEHAVIORAL SINK SIMULATION ENGINE
        // ============================================================================
        
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const timelineCanvas = document.getElementById('timelineChart');
        const timelineCtx = timelineCanvas.getContext('2d');
        
        // Simulation state
        let agents = [];
        let running = false;
        let time = 0;
        let phase = 1;
        
        // Historical data for charts
        let history = {
            population: [],
            reproduction: [],
            violence: [],
            withdrawal: [],
            pathology: [],
            actualAbundance: [],
            perceivedAbundance: [],
            friction: []
        };
        
        // Parameters - NOTE: friction is now EMERGENT from abstraction + abundance
        let params = {
            initialPopulation: 50,       // Starting agent count (slider-controlled)
            resourceAbundance: 100,      // This is now PERCEIVED abundance (what symbols say)
            symbolicComplexity: 1.0,
            enableEcologicalDynamics: false  // Toggle for full lifecycle simulation
        };
        
        // Calculated real-time density (agents per 1000 px¬≤)
        function getActualDensity() {
            const area = canvas.width * canvas.height;
            return (agents.length / area) * 1000;  // Per 1000 px¬≤
        }
        
        // ============================================================
        // ECOLOGICAL DYNAMICS - The Full Lifecycle
        // ============================================================
        // Two abundances that can DIVERGE:
        // - PERCEIVED: What consciousness believes (maintained by symbols)
        // - ACTUAL: Real ecological carrying capacity (depletes with extraction)
        //
        // EARTH OVERSHOOT: Currently humanity consumes ~1.7x Earth's annual
        // regeneration capacity. This factor grows with abstraction (which
        // enables frictionless extraction) until ecology is exhausted.
        //
        // High abstraction enables EXTRACTION while maintaining PERCEPTION
        // The divergence grows until symbols fail to conjure real resources
        // Then: catastrophic correction as perceived crashes to actual
        // Then: friction ‚Üí 100% as only physical survival remains
        // ============================================================
        let ecologicalState = {
            actualAbundance: 100,        // Real ecological resources (depletes)
            perceivedAbundance: 100,     // What symbols say (can diverge from actual)
            
            // EARTH OVERSHOOT FACTOR - consumption relative to regeneration
            // 1.0 = sustainable (consume what Earth regenerates)
            // 1.7 = current humanity (consuming 1.7x annual regeneration)
            // >2.0 = rapid depletion
            // Higher abstraction drives this up (extraction without feedback)
            // Higher friction drives this down (extraction requires effort)
            overshootFactor: 1.0,        // Calculated each tick
            
            // Regeneration capacity - can be permanently damaged
            regenerationCapacity: 100,   // Starts at 100%, can degrade (soil, biodiversity)
            
            // CUMULATIVE EXTRACTIVE DEBT
            // This is the KEY missing variable - overshoot ACCUMULATES
            // Each tick of overshoot > 1.0 adds to debt
            // Debt creates TENSION that eventually must correct
            // Like a spring being stretched - energy stored for release
            extractiveDebt: 0,           // Cumulative sum of overshoot - 1.0 (when positive)
            
            extractionRate: 0,           // How fast we're depleting actual
            divergence: 0,               // Gap between perceived and actual
            symbolIntegrity: 100,        // How well symbols still "work"
            collapsed: false             // Terminal state flag
        };
        
        function updateEcologicalDynamics() {
            if (!params.enableEcologicalDynamics) return;
            
            // ============================================================
            // OVERSHOOT FACTOR CALCULATION
            // ============================================================
            // EMPIRICAL GROUNDING:
            // - Current humanity: 1.7x overshoot (Earth Overshoot Day ~Aug 2)
            // - Pre-industrial: ~0.8x (some slack for recovery)
            // - Hunter-gatherer: ~0.3-0.5x (abundance relative to extraction)
            // - Industrial peak scenarios: 2.5-4.0x
            //
            // The model: Overshoot = f(abstraction, friction, population, perception)
            // ============================================================
            
            const friction = getEffectiveFriction();
            
            // Base extraction: population-driven metabolic minimum
            // Even with zero abstraction, N people extract N units
            // Scaled to: 100 people at sustainable extraction = overshoot 1.0
            const basePopulationFactor = agents.length / 100;
            let overshoot = basePopulationFactor;
            
            // ABSTRACTION MULTIPLIER
            // Empirical grounding: GDP/capita correlates with ecological footprint
            // US (high abstraction) ~5x footprint of India (lower abstraction)
            // Model: abstraction enables per-capita extraction amplification
            // At complexity 1.0: no amplification (direct subsistence)
            // At complexity 5.0: 2x amplification (industrial economy)  
            // At complexity 10.0: 4x amplification (financialized extraction)
            const abstractionMultiplier = 1 + Math.pow((params.symbolicComplexity - 1) / 9, 1.5) * 3;
            overshoot *= abstractionMultiplier;
            
            // FRICTION DAMPENER
            // High friction = each unit of extraction requires real effort
            // Low friction = extraction is "free" (externalized costs)
            // At friction 1.0: extraction dampened by 60%
            // At friction 0.1: extraction at full abstraction-enabled rate
            const frictionDampener = 1 - (friction * 0.6);
            overshoot *= frictionDampener;
            
            // PERCEPTION ACCELERATOR
            // When you PERCEIVE abundance, you consume more (Jevons paradox)
            // Empirical: efficiency gains ‚Üí increased consumption
            // Model: perceived abundance > actual ‚Üí overconsumption
            // This creates positive feedback until correction
            const perceptionRatio = ecologicalState.perceivedAbundance / Math.max(1, ecologicalState.actualAbundance);
            const perceptionAccelerator = Math.pow(perceptionRatio, 0.5); // Square root - diminishing effect
            overshoot *= perceptionAccelerator;
            
            ecologicalState.overshootFactor = Math.max(0.1, Math.min(10, overshoot));
            
            // ============================================================
            // CUMULATIVE EXTRACTIVE DEBT
            // ============================================================
            // This is the "spring tension" that must eventually release
            // Debt = integral of (overshoot - 1) over time when positive
            // Higher abstraction can HOLD more debt (delay correction longer)
            // But debt held under tension eventually releases catastrophically
            // ============================================================
            
            if (ecologicalState.overshootFactor > 1.0) {
                // Accumulating debt - nonlinear (debt grows faster as it increases)
                const newDebt = (ecologicalState.overshootFactor - 1.0) * 0.1;
                // Debt compounds slightly - the more debt, the harder to stop
                const compoundFactor = 1 + ecologicalState.extractiveDebt * 0.001;
                ecologicalState.extractiveDebt += newDebt * compoundFactor;
            } else {
                // Below sustainable - slowly paying down debt
                // But debt paydown is MUCH slower than accumulation (hysteresis)
                const paydown = (1.0 - ecologicalState.overshootFactor) * 0.02;
                ecologicalState.extractiveDebt = Math.max(0, ecologicalState.extractiveDebt - paydown);
            }
            
            // Cap debt (at some point, correction is forced)
            ecologicalState.extractiveDebt = Math.min(100, ecologicalState.extractiveDebt);
            
            // ============================================================
            // EXTRACTION AND REGENERATION
            // ============================================================
            // EMPIRICAL GROUNDING:
            // - Earth's biocapacity regenerates ~1.6 gha/person/year
            // - Actual consumption: ~2.8 gha/person/year globally
            // - Regeneration CAN recover, but slowly (decades for forests, centuries for soil)
            // 
            // Model: net extraction = (overshoot - 1) * regeneration capacity
            // ============================================================
            
            const baseRegeneration = ecologicalState.regenerationCapacity * 0.01; // 1% per tick at full capacity
            const grossExtraction = baseRegeneration * ecologicalState.overshootFactor;
            
            ecologicalState.extractionRate = grossExtraction - baseRegeneration;
            
            // ACTUAL ABUNDANCE changes
            // Depletion rate scales with debt tension (stressed systems break faster)
            const debtStressFactor = 1 + ecologicalState.extractiveDebt * 0.01;
            ecologicalState.actualAbundance -= ecologicalState.extractionRate * debtStressFactor;
            ecologicalState.actualAbundance = Math.max(0, Math.min(200, ecologicalState.actualAbundance));
            
            // ============================================================
            // REGENERATION CAPACITY DAMAGE
            // ============================================================
            // EMPIRICAL GROUNDING:
            // - Topsoil: loses 1% per year under intensive agriculture
            // - Biodiversity: ~1% species loss per decade accelerating
            // - Aquifers: some regions depleting at 1-3% annually
            // - Recovery: topsoil = 500-1000 years, aquifers = centuries
            //
            // Model: damage threshold at overshoot 1.5, exponential above 2.0
            // Recovery only possible below overshoot 0.8 (slack needed)
            // ============================================================
            
            if (ecologicalState.overshootFactor > 2.0) {
                // Exponential damage above 2.0 - ecosystem cascades
                const excessOvershoot = ecologicalState.overshootFactor - 2.0;
                const damage = Math.pow(excessOvershoot, 1.5) * 0.02;
                ecologicalState.regenerationCapacity -= damage;
            } else if (ecologicalState.overshootFactor > 1.5) {
                // Linear damage between 1.5 and 2.0
                const damage = (ecologicalState.overshootFactor - 1.5) * 0.01;
                ecologicalState.regenerationCapacity -= damage;
            } else if (ecologicalState.overshootFactor < 0.8 && ecologicalState.regenerationCapacity < 100) {
                // Very slow recovery - must be well below sustainable
                // AND recovery slows as capacity returns (diminishing returns)
                const recoveryRoom = 100 - ecologicalState.regenerationCapacity;
                ecologicalState.regenerationCapacity += 0.001 * (recoveryRoom / 100);
            }
            ecologicalState.regenerationCapacity = Math.max(0, Math.min(100, ecologicalState.regenerationCapacity));
            
            // ============================================================
            // PERCEIVED ABUNDANCE DYNAMICS
            // ============================================================
            // This is where SYMBOLS do their work.
            // Abstraction MAINTAINS perceived abundance despite actual decline.
            // Think: stock market valuations, GDP growth narratives, "innovation will save us"
            //
            // EMPIRICAL GROUNDING:
            // - Markets routinely maintain 30-50% divergence from fundamentals
            // - Housing bubble 2008: ~40% divergence before correction
            // - Dot-com: ~60-70% divergence at peak
            // - But: higher financialization ‚Üí larger possible divergence
            //
            // Model: abstraction allows divergence, debt FORCES correction
            // ============================================================
            
            ecologicalState.divergence = ecologicalState.perceivedAbundance - ecologicalState.actualAbundance;
            
            // Maximum sustainable divergence scales with abstraction
            // Low abstraction: reality felt directly, can't diverge far
            // High abstraction: symbols can maintain large divergence
            // BUT: extractive debt creates pressure toward correction
            const baseMaxDivergence = params.symbolicComplexity * 10; // 10-100 depending on abstraction
            const debtPressure = ecologicalState.extractiveDebt * 0.5; // Debt reduces sustainable divergence
            const maxSustainableDivergence = Math.max(5, baseMaxDivergence - debtPressure);
            
            // SYMBOL INTEGRITY: ability of abstraction to maintain the divergence
            if (ecologicalState.divergence > maxSustainableDivergence) {
                // Symbols straining - integrity degrades
                const strain = (ecologicalState.divergence - maxSustainableDivergence) / maxSustainableDivergence;
                // Exponential degradation under high strain
                ecologicalState.symbolIntegrity -= Math.pow(strain, 1.5) * 2;
            } else if (ecologicalState.divergence < maxSustainableDivergence * 0.5) {
                // Symbols recovering when under low strain
                ecologicalState.symbolIntegrity = Math.min(100, ecologicalState.symbolIntegrity + 0.2);
            }
            ecologicalState.symbolIntegrity = Math.max(0, Math.min(100, ecologicalState.symbolIntegrity));
            
            // PERCEIVED ABUNDANCE ADJUSTMENT
            // ============================================================
            // THE CORE PATHOLOGY: You cannot consciously choose to perceive
            // reality correctly. Symbolic abstraction HIJACKS perception.
            // 
            // High abstraction doesn't just "maintain" perception‚Äîit actively
            // INFLATES perceived abundance toward fantasy narratives:
            // - "The economy is growing" (GDP says so)
            // - "Innovation will solve it" (tech narratives)
            // - "We have plenty" (supermarket shelves)
            // - "My portfolio is up" (numbers on screens)
            //
            // None of these symbols have intrinsic ecological value.
            // They cannot fill stomachs, they cannot regenerate soil.
            // But they convince brains that abundance is unlimited.
            // ============================================================
            
            // Force 1: ABSTRACTION-DRIVEN FANTASY
            // Higher abstraction = stronger push toward INFLATED perception
            // This is NOT a conscious choice - it's what high abstraction DOES
            // The fantasy narrative ACTIVELY GROWS perceived abundance
            const abstractionPower = params.symbolicComplexity / 10;  // 0.1 to 1.0
            const fantasyTarget = 100 + (abstractionPower * 80);  // Up to 180% fantasy "abundance"
            const fantasyPull = abstractionPower * 0.05;  // How fast fantasy inflates
            const distanceToFantasy = fantasyTarget - ecologicalState.perceivedAbundance;
            const inflationForce = distanceToFantasy * fantasyPull;
            
            // Force 2: Reality correction - ONLY when symbols fail
            // Until symbols break, reality has NO VOICE
            // This is why the crash is catastrophic - no gradual feedback
            const symbolFailure = Math.max(0, (50 - ecologicalState.symbolIntegrity) / 50);
            const debtCorrection = ecologicalState.extractiveDebt / 100;
            const totalCorrectionForce = (symbolFailure + debtCorrection) * 0.4;
            
            // Net change in perceived
            const gapToActual = ecologicalState.perceivedAbundance - ecologicalState.actualAbundance;
            
            // Fantasy inflates perceived (irrational - NOT a conscious choice)
            ecologicalState.perceivedAbundance += inflationForce;
            // Reality only corrects when symbols fail (catastrophic, not gradual)
            ecologicalState.perceivedAbundance -= gapToActual * totalCorrectionForce;
            
            ecologicalState.perceivedAbundance = Math.max(0, Math.min(200, ecologicalState.perceivedAbundance));
            
            // ============================================================
            // TERMINAL COLLAPSE
            // ============================================================
            // Collapse occurs when: debt is extreme AND symbols have failed
            // This is the "correction" - all accumulated tension releases
            // ============================================================
            
            if (ecologicalState.symbolIntegrity < 10 && ecologicalState.extractiveDebt > 50) {
                ecologicalState.collapsed = true;
                // Immediate crash: perceived ‚Üí actual
                ecologicalState.perceivedAbundance = ecologicalState.actualAbundance;
                // Debt "releases" as destruction (but damage is done)
                ecologicalState.extractiveDebt *= 0.9; // Slowly discharges
                // Abstraction becomes meaningless
                params.symbolicComplexity = Math.max(1.0, params.symbolicComplexity * 0.95);
            }
            
            // Can recover from collapse if actual abundance recovers
            if (ecologicalState.collapsed && ecologicalState.actualAbundance > 40 && ecologicalState.extractiveDebt < 20) {
                ecologicalState.collapsed = false;
                ecologicalState.symbolIntegrity = 30; // Symbols slowly rebuild
            }
            
            // Update the params that agents use
            params.resourceAbundance = ecologicalState.perceivedAbundance;
        }
        
        // ============================================================
        // FRICTION CALCULATION - The key insight
        // ============================================================
        // Friction is NOT an independent variable!
        // High abstraction ENABLES low friction (you can't have frictionless
        // barter, but you CAN have frictionless digital currency).
        //
        // The relationship:
        // - LOW abstraction (1.0-2.0): Friction MUST be high (physical reality)
        //   ‚Ä¢ Barter requires physical exchange
        //   ‚Ä¢ Status requires visible action
        //   ‚Ä¢ Social bonds require time investment
        //
        // - HIGH abstraction (5.0+): Friction CAN be very low
        //   ‚Ä¢ Money = abstract tokens, transferable instantly
        //   ‚Ä¢ Social media = likes require no real investment
        //   ‚Ä¢ Status symbols = disconnected from production
        //
        // The key: abstraction doesn't automatically lower friction,
        // but it REMOVES THE FLOOR. Without abstraction, friction
        // has a physical minimum. With abstraction, that minimum
        // approaches zero.
        //
        // Abundance then exploits this potential:
        // - Low abundance + high abstraction = friction still felt (scarcity signals)
        // - High abundance + high abstraction = friction approaches zero
        // ============================================================
        function getEffectiveFriction() {
            // ============================================================
            // TERMINAL STATE: When symbols collapse, friction ‚Üí 100%
            // ============================================================
            // In ecological collapse, abstraction becomes meaningless
            // Every action requires maximum physical effort
            // No shortcuts, no symbols, pure survival (or death)
            // ============================================================
            if (params.enableEcologicalDynamics && ecologicalState.collapsed) {
                // Friction spikes to maximum - symbols are worthless
                // Only physical reality remains
                const collapseIntensity = (100 - ecologicalState.actualAbundance) / 100;
                return Math.min(1.0, 0.9 + collapseIntensity * 0.1); // 0.9 to 1.0
            }
            
            // Physical minimum friction at each abstraction level
            // Low abstraction = high floor (can't escape physical constraints)
            // High abstraction = low floor (physical constraints removable)
            const abstractionLevel = params.symbolicComplexity;
            
            // The "friction floor" - minimum possible friction at this abstraction level
            // At complexity 1.0: floor = 0.8 (barter, direct exchange - high friction unavoidable)
            // At complexity 5.0: floor = 0.2 (money - friction CAN be very low)
            // At complexity 10.0: floor = 0.05 (digital - friction approaches zero)
            const frictionFloor = Math.max(0.05, 0.9 - (abstractionLevel - 1) * 0.1);
            
            // How much friction is actually realized depends on resource abundance
            // Scarcity creates friction even in abstract systems (credit checks, etc.)
            // Abundance removes whatever friction abstraction makes removable
            // Use ACTUAL abundance if ecological dynamics enabled, else perceived
            const relevantAbundance = params.enableEcologicalDynamics 
                ? ecologicalState.actualAbundance 
                : params.resourceAbundance;
            const abundanceFactor = relevantAbundance / 100;
            
            // Realized friction: starts at floor, rises with scarcity
            // At abundance 200%: friction = floor (all removable friction removed)
            // At abundance 50%: friction = floor + 0.3 (scarcity adds friction)
            const scarcityFriction = Math.max(0, (1 - abundanceFactor) * 0.4);
            
            // Symbol integrity affects how well abstraction "works"
            // Failing symbols can't reduce friction as effectively
            const symbolEffectiveness = params.enableEcologicalDynamics 
                ? ecologicalState.symbolIntegrity / 100 
                : 1.0;
            const effectiveFloor = frictionFloor + (0.9 - frictionFloor) * (1 - symbolEffectiveness);
            
            // Final friction = effective floor + scarcity component
            const effectiveFriction = effectiveFloor + scarcityFriction;
            
            // Clamp to reasonable range
            return Math.max(0.05, Math.min(1.0, effectiveFriction));
        }
        
        // Agent class
        class Agent {
            constructor(x, y, inherited = null) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 2;
                this.vy = (Math.random() - 0.5) * 2;
                this.size = 6;
                this.health = 100;
                // Offspring can inherit reduced reproductive health from stressed parents
                this.reproductiveHealth = inherited ? Math.min(100, inherited + 20) : 100;
                this.socialStatus = Math.random() * 100;
                this.withdrawn = false;
                this.stressed = false;
                this.violent = false;
                this.age = 0;
                // Base lifespan - but actual death depends on CONDITIONS not just age
                this.baseLifespan = 600 + Math.random() * 400;
                this.color = this.getColor();
                this.lastReproduced = -100; // Cooldown tracking
            }
            
            getColor() {
                if (this.withdrawn) return '#6b7280'; // Gray - withdrawn
                if (this.violent) return '#ef4444'; // Red - violent
                if (this.stressed) return '#f59e0b'; // Orange - stressed
                if (this.reproductiveHealth < 30) return '#ec4899'; // Pink - reproductive failure
                return '#3b82f6'; // Blue - healthy
            }
            
            // Calculate if agent should die - Calhoun-accurate: healthy conditions = long life
            shouldDie() {
                // Health-based death (starvation, violence, etc.)
                if (this.health <= 0) return true;
                
                // Age-related mortality increases with age, but HEALTHY agents live longer
                const ageRatio = this.age / this.baseLifespan;
                
                // In GOOD conditions (low complexity, high friction), agents live much longer
                const conditionBonus = (2 - params.symbolicComplexity * 0.15) * (1 + getEffectiveFriction());
                const effectiveAgeRatio = ageRatio / Math.max(0.5, conditionBonus);
                
                // Very low mortality until old age
                if (effectiveAgeRatio < 0.7) return false;
                
                // Gradual increase in mortality after 70% of effective lifespan
                const mortalityChance = Math.pow(effectiveAgeRatio - 0.7, 2) * 0.01;
                return Math.random() < mortalityChance;
            }
            
            update() {
                this.age++;
                
                // Movement - friction affects damping but agents can still move
                const dampingFactor = 0.98 - (getEffectiveFriction() * 0.03);
                this.vx *= dampingFactor;
                this.vy *= dampingFactor;
                
                // Random walk - all agents wander
                const walkForce = 0.3;
                this.vx += (Math.random() - 0.5) * walkForce;
                this.vy += (Math.random() - 0.5) * walkForce;
                
                // Speed limit
                const maxSpeed = 2.5;
                const speed = Math.sqrt(this.vx**2 + this.vy**2);
                if (speed > maxSpeed) {
                    this.vx = (this.vx / speed) * maxSpeed;
                    this.vy = (this.vy / speed) * maxSpeed;
                }
                
                // Move
                this.x += this.vx;
                this.y += this.vy;
                
                // Bounce off walls
                if (this.x < this.size || this.x > canvas.width - this.size) {
                    this.vx *= -1;
                    this.x = Math.max(this.size, Math.min(canvas.width - this.size, this.x));
                }
                if (this.y < this.size || this.y > canvas.height - this.size) {
                    this.vy *= -1;
                    this.y = Math.max(this.size, Math.min(canvas.height - this.size, this.y));
                }
                
                // ============================================================
                // STRESS CALCULATION - NiCE Framework / Calhoun Reinterpretation
                // 
                // TWO TYPES OF STRESS:
                // 1. ECOLOGICAL STRESS: Real resource scarcity - healthy feedback when felt
                // 2. SYMBOLIC STRESS: Status competition decoupled from biology - pathological
                //
                // LOW symbolic complexity + HIGH friction = reality accurately felt
                //   ‚Üí Low resources SHOULD cause stress (healthy ecological feedback)
                //   ‚Üí High resources = thriving
                //
                // HIGH symbolic complexity + LOW friction = reality hidden
                //   ‚Üí Brain can't distinguish real vs symbolic rewards
                //   ‚Üí Behaves as if resources unlimited regardless of reality
                //   ‚Üí Status competition replaces biological imperatives
                // ============================================================
                
                const nearbyAgents = agents.filter(other => 
                    other !== this && 
                    Math.hypot(this.x - other.x, this.y - other.y) < 60
                ).length;
                
                // ECOLOGICAL STRESS: Real resource scarcity
                // This is HEALTHY feedback - felt more strongly when complexity is LOW (reality is clear)
                const resourceScarcity = Math.max(0, (100 - params.resourceAbundance) / 100);
                // Low complexity = reality clearly felt; high complexity = reality hidden
                const realityClarity = Math.max(0.2, 1 - (params.symbolicComplexity - 1) * 0.15);
                const ecologicalStress = resourceScarcity * 30 * realityClarity;
                
                // SYMBOLIC STRESS: Status competition decoupled from biology (THE PATHOLOGY)
                // Only kicks in at higher complexity levels (>2.0) - below that is normal social structure
                // Scale is gentler: complexity 1.0-2.0 = minimal symbolic stress
                const symbolicStress = Math.max(0, Math.pow(params.symbolicComplexity - 2.0, 1.5) * 12);
                
                // FRICTION determines whether SYMBOLIC stress self-corrects
                // (Ecological stress is already real - friction doesn't change that)
                const frictionProtection = getEffectiveFriction() * 2;
                const effectiveSymbolicStress = symbolicStress / (1 + frictionProtection);
                
                // Density amplifies SYMBOLIC stress only (not ecological)
                const densityAmplifier = nearbyAgents > 5 ? 1 + (nearbyAgents - 5) * 0.08 : 1.0;
                
                // Total stress = ecological (real) + symbolic (pathological if decoupled)
                const totalStress = ecologicalStress + (effectiveSymbolicStress * densityAmplifier);
                
                this.stressed = totalStress > 15;
                
                // ============================================================
                // HEALTH DYNAMICS - Two pathways to decline
                // 1. ECOLOGICAL: Low resources + reality felt = starvation (natural)
                // 2. SYMBOLIC: High complexity + low friction = pathological stress
                // ============================================================
                
                const resourceFactor = params.resourceAbundance / 100;
                
                // ECOLOGICAL HEALTH: Based on real resource availability
                // When reality is clearly felt (low complexity), resources directly impact health
                const ecologicalHealthChange = (resourceFactor - 0.8) * 0.15 * realityClarity;
                this.health += ecologicalHealthChange;
                
                // SYMBOLIC STRESS damages health (this is the pathological component)
                if (effectiveSymbolicStress > 10) {
                    const symbolicDamage = (effectiveSymbolicStress / 100) * 0.12;
                    this.health -= symbolicDamage;
                    
                    // REPRODUCTIVE HEALTH is ESPECIALLY sensitive to symbolic stress
                    // This is Calhoun's key finding: status competition replaces mating
                    const reproductiveDamage = symbolicDamage * (1.5 + params.symbolicComplexity * 0.15);
                    this.reproductiveHealth -= reproductiveDamage;
                }
                
                // Base health recovery (metabolism, rest)
                this.health += 0.08;
                
                // Reproductive health dynamics
                if (!this.stressed) {
                    // Recovery when not stressed - resources help
                    const reproRecovery = 0.12 * resourceFactor;
                    this.reproductiveHealth += reproRecovery;
                } else if (ecologicalStress > 10 && effectiveSymbolicStress < 5) {
                    // ECOLOGICAL stress reduces reproduction (healthy natural response)
                    // This is NOT pathological - it's appropriate response to scarcity
                    this.reproductiveHealth -= 0.05 * (ecologicalStress / 30);
                }
                
                // ============================================================
                // BEHAVIORAL SINK SYMPTOMS - Only emerge under specific conditions
                // ============================================================
                
                // Violence and withdrawal only emerge when:
                // 1. Reproductive health is low (chronic stress effect)
                // 2. Symbolic complexity is HIGH (not just any stress)
                // This matches Calhoun: "beautiful ones" and violent males emerged ONLY 
                // in high-complexity, frictionless environments
                
                if (this.reproductiveHealth < 30 && params.symbolicComplexity > 2.5) {
                    // High complexity + reproductive failure = behavioral pathology
                    const pathologyChance = 0.002 * (params.symbolicComplexity - 2);
                    if (Math.random() < pathologyChance) {
                        if (Math.random() < 0.5) {
                            this.violent = true;
                            this.withdrawn = false;
                        } else {
                            this.withdrawn = true;
                            this.violent = false;
                        }
                    }
                }
                
                // Social withdrawal from CHRONIC high stress (not acute)
                if (totalStress > 50 && this.stressed && Math.random() < 0.002) {
                    this.withdrawn = true;
                }
                
                // RECOVERY from pathological states - possible if conditions improve!
                // This is key: Calhoun noted that removing mice to better conditions
                // sometimes allowed recovery (if not too far gone)
                if ((this.violent || this.withdrawn) && !this.stressed && this.reproductiveHealth > 60) {
                    if (Math.random() < 0.01) {
                        this.violent = false;
                        this.withdrawn = false;
                    }
                }
                
                // Clamp values
                this.health = Math.max(0, Math.min(100, this.health));
                this.reproductiveHealth = Math.max(0, Math.min(100, this.reproductiveHealth));
                
                // Update color
                this.color = this.getColor();
            }
            
            draw() {
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                
                // Draw status indicator for violent agents
                if (this.violent) {
                    ctx.strokeStyle = '#dc2626';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size + 3, 0, Math.PI * 2);
                    ctx.stroke();
                }
                
                // Draw faded circle for withdrawn agents
                if (this.withdrawn) {
                    ctx.globalAlpha = 0.3;
                    ctx.fillStyle = '#6b7280';
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size + 5, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.globalAlpha = 1.0;
                }
            }
        }
        
        // Initialize simulation
        function init() {
            agents = [];
            for (let i = 0; i < params.initialPopulation; i++) {
                agents.push(new Agent(
                    Math.random() * (canvas.width - 40) + 20,
                    Math.random() * (canvas.height - 40) + 20
                ));
            }
            time = 0;
            phase = 1;
            history = {
                population: [],
                reproduction: [],
                violence: [],
                withdrawal: [],
                pathology: [],
                actualAbundance: [],
                perceivedAbundance: [],
                friction: []
            };
            
            // Reset ecological state if ecological dynamics are enabled
            if (params.enableEcologicalDynamics) {
                ecologicalState.actualAbundance = params.resourceAbundance;
                ecologicalState.perceivedAbundance = params.resourceAbundance;
                ecologicalState.overshootFactor = 1.0;
                ecologicalState.regenerationCapacity = 100;
                ecologicalState.extractiveDebt = 0;
                ecologicalState.extractionRate = 0;
                ecologicalState.divergence = 0;
                ecologicalState.symbolIntegrity = 100;
                ecologicalState.collapsed = false;
            }
        }
        
        // Reproduction logic - Calhoun-accurate: healthy populations reproduce steadily
        // Only under behavioral sink conditions does reproduction collapse
        function reproduce() {
            // Soft population cap based on space, not hard limit
            const spaceArea = canvas.width * canvas.height;
            const agentArea = Math.PI * 30 * 30; // Comfortable space per agent
            const comfortableCap = Math.floor(spaceArea / agentArea) * 1.5;
            
            if (agents.length >= comfortableCap) return;
            
            // Find reproductively capable agents
            const fertileAgents = agents.filter(a => 
                !a.withdrawn && 
                !a.violent && 
                a.reproductiveHealth > 50 && 
                a.health > 50 &&
                a.age > 50 && // Maturity
                (time - a.lastReproduced) > 100 // Cooldown between births
            );
            
            // ============================================================
            // REPRODUCTION RATE - Two influences:
            // 1. ECOLOGICAL: Resource availability (felt when complexity is low)
            // 2. SYMBOLIC: Decoupling from biology (pathological)
            // ============================================================
            // 
            // LOW complexity = reality accurately felt:
            //   - Low resources ‚Üí low reproduction (healthy ecological response)
            //   - High resources ‚Üí healthy reproduction
            //
            // HIGH complexity = reality hidden:
            //   - Resources don't matter - status competition replaces mating
            //   - Brain thinks resources unlimited, pursues status instead
            //   - Reproduction collapses regardless of actual resource level
            // ============================================================
            
            // How clearly is ecological reality perceived?
            const realityClarity = Math.max(0.2, 1 - (params.symbolicComplexity - 1) * 0.15);
            
            // ECOLOGICAL factor: Resources affect reproduction when reality is felt
            // This is NATURAL - low resources SHOULD reduce reproduction
            const resourceEffect = params.resourceAbundance / 100;
            const ecologicalReproFactor = 0.5 + (resourceEffect * 0.5 * realityClarity) + (0.5 * (1 - realityClarity));
            
            // SYMBOLIC DECOUPLING: The pathological factor
            // Only significant above complexity 2.0 - below that is normal social structure
            const symbolicDecoupling = Math.max(0, params.symbolicComplexity - 2.0);
            const frictionGrounding = getEffectiveFriction();
            
            // Decoupling ratio: symbolic complexity that friction can't ground
            const decouplingRatio = symbolicDecoupling / (0.5 + frictionGrounding);
            
            // Symbolic reproduction factor: decays with decoupling
            // This represents status competition REPLACING biological reproduction
            const symbolicReproFactor = Math.exp(-decouplingRatio * 0.4);
            
            // Friction bonus (grounded behaviors support healthy reproduction)
            const frictionBonus = 1 + getEffectiveFriction() * 0.15;
            
            // Natural density regulation - gentle curve
            const spacePerAgent = (canvas.width * canvas.height) / Math.max(1, agents.length);
            const minComfortableSpace = 800; // pixels^2 per agent
            const spaceComfort = Math.min(1.2, spacePerAgent / minComfortableSpace);
            
            // FINAL REPRODUCTION RATE combines ecological and symbolic factors
            const baseRate = 0.14;
            const reproductionRate = baseRate * ecologicalReproFactor * symbolicReproFactor * frictionBonus * spaceComfort;
            
            // Process reproduction
            fertileAgents.forEach(parent => {
                if (Math.random() < reproductionRate) {
                    const child = new Agent(
                        parent.x + (Math.random() - 0.5) * 40,
                        parent.y + (Math.random() - 0.5) * 40,
                        parent.reproductiveHealth // Pass parent's reproductive health for inheritance
                    );
                    agents.push(child);
                    parent.lastReproduced = time;
                }
            });
        }
        
        // Death logic - Calhoun-accurate: healthy conditions = long life
        function removeDead() {
            agents = agents.filter(a => !a.shouldDie());
        }
        
        // Update phase
        function updatePhase() {
            const avgReproHealth = agents.reduce((sum, a) => sum + a.reproductiveHealth, 0) / agents.length;
            const violentCount = agents.filter(a => a.violent).length;
            const withdrawnCount = agents.filter(a => a.withdrawn).length;
            const pathologyRate = (violentCount + withdrawnCount) / agents.length;
            
            let newPhase = 1;
            let phaseLabel = '';
            let phaseColor = '';
            
            if (pathologyRate > 0.4 || avgReproHealth < 20) {
                newPhase = 4;
                phaseLabel = 'Phase 4: Collapse';
                phaseColor = 'bg-red-500/20 text-red-300';
            } else if (pathologyRate > 0.2 || avgReproHealth < 40) {
                newPhase = 3;
                phaseLabel = 'Phase 3: Pathological';
                phaseColor = 'bg-orange-500/20 text-orange-300';
            } else if (params.symbolicComplexity > 2 || agents.length > params.initialPopulation * 1.5) {
                newPhase = 2;
                phaseLabel = 'Phase 2: Symbolic Overload';
                phaseColor = 'bg-yellow-500/20 text-yellow-300';
            } else {
                newPhase = 1;
                phaseLabel = 'Phase 1: Equilibrium';
                phaseColor = 'bg-green-500/20 text-green-300';
            }
            
            if (newPhase !== phase) {
                phase = newPhase;
                const phaseDisplay = document.getElementById('phase-display');
                phaseDisplay.textContent = phaseLabel;
                phaseDisplay.className = 'phase-indicator ' + phaseColor;
            }
        }
        
        // Update metrics display
        function updateMetrics() {
            document.getElementById('populationMetric').textContent = agents.length;
            
            // Update ACTUAL density in real-time
            document.getElementById('actualDensityMetric').textContent = getActualDensity().toFixed(2);
            
            // Handle empty population case
            if (agents.length === 0) {
                document.getElementById('reproductionMetric').textContent = '0%';
                document.getElementById('pathologyMetric').textContent = 'N/A';
                document.getElementById('withdrawalMetric').textContent = 'N/A';
                document.getElementById('actualDensityMetric').textContent = '0.00';
                return;
            }
            
            const avgReproHealth = agents.reduce((sum, a) => sum + a.reproductiveHealth, 0) / agents.length;
            document.getElementById('reproductionMetric').textContent = Math.round(avgReproHealth) + '%';
            
            let complexityLabel = 'Low';
            if (params.symbolicComplexity > 5) complexityLabel = 'Extreme';
            else if (params.symbolicComplexity > 3) complexityLabel = 'High';
            else if (params.symbolicComplexity > 1.5) complexityLabel = 'Medium';
            document.getElementById('complexityMetric').textContent = complexityLabel;
            
            const violentCount = agents.filter(a => a.violent).length;
            const withdrawnCount = agents.filter(a => a.withdrawn).length;
            const pathologyRate = ((violentCount + withdrawnCount) / agents.length * 100).toFixed(1);
            document.getElementById('pathologyMetric').textContent = pathologyRate + '%';
            
            const withdrawalRate = (withdrawnCount / agents.length * 100).toFixed(1);
            document.getElementById('withdrawalMetric').textContent = withdrawalRate + '%';
            
            // Record history
            if (time % 10 === 0) {
                history.population.push(agents.length);
                history.reproduction.push(avgReproHealth);
                history.violence.push(violentCount / agents.length * 100);
                history.withdrawal.push(withdrawnCount / agents.length * 100);
                history.pathology.push(parseFloat(pathologyRate));
                
                // Record ecological history when enabled
                if (params.enableEcologicalDynamics) {
                    history.actualAbundance.push(ecologicalState.actualAbundance / 2); // Scale to 0-100
                    history.perceivedAbundance.push(ecologicalState.perceivedAbundance / 2);
                    history.friction.push(getEffectiveFriction() * 100);
                }
                
                // Keep only last 200 data points
                if (history.population.length > 200) {
                    for (let key in history) {
                        history[key].shift();
                    }
                }
            }
        }
        
        // Draw timeline chart
        function drawTimeline() {
            const ctx = timelineCtx;
            const w = timelineCanvas.width;
            const h = timelineCanvas.height;
            
            // Clear
            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.fillRect(0, 0, w, h);
            
            if (history.population.length < 2) return;
            
            // Draw grid
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 10; i++) {
                const y = (h / 10) * i;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(w, y);
                ctx.stroke();
            }
            
            // Draw lines
            const datasets = [
                { data: history.reproduction, color: '#10b981', label: 'Repro Health %' },
                { data: history.violence, color: '#ef4444', label: 'Violence %' },
                { data: history.withdrawal, color: '#6b7280', label: 'Withdrawal %' },
                { data: history.pathology, color: '#f59e0b', label: 'Pathology %' }
            ];
            
            // Also draw population as a scaled line
            const maxPop = Math.max(...history.population, params.initialPopulation * 2);
            const popData = history.population.map(p => (p / maxPop) * 100);
            datasets.unshift({ data: popData, color: '#3b82f6', label: `Population (/${maxPop})` });
            
            datasets.forEach(dataset => {
                ctx.strokeStyle = dataset.color;
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                dataset.data.forEach((value, i) => {
                    const x = (i / (history.population.length - 1)) * w;
                    const y = h - (value / 100) * h;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                
                ctx.stroke();
            });
            
            // Add ecological datasets when enabled
            if (params.enableEcologicalDynamics && history.actualAbundance.length > 1) {
                const ecologicalDatasets = [
                    { data: history.actualAbundance, color: '#06b6d4', label: 'Actual Abundance %' },
                    { data: history.perceivedAbundance, color: '#22c55e', label: 'Perceived Abundance %' }
                ];
                
                ecologicalDatasets.forEach(dataset => {
                    ctx.strokeStyle = dataset.color;
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 3]); // Dashed lines for ecological
                    ctx.beginPath();
                    
                    dataset.data.forEach((value, i) => {
                        const x = (i / (history.actualAbundance.length - 1)) * w;
                        const y = h - (value / 100) * h;
                        if (i === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    });
                    
                    ctx.stroke();
                    ctx.setLineDash([]); // Reset
                });
                
                // Update legend to include ecological
                datasets.push(...ecologicalDatasets);
            }
            
            // Draw legend
            ctx.font = '12px Inter';
            datasets.forEach((dataset, i) => {
                ctx.fillStyle = dataset.color;
                ctx.fillRect(10, 10 + i * 20, 12, 12);
                ctx.fillText(dataset.label, 28, 20 + i * 20);
            });
        }
        
        // Main animation loop
        function animate() {
            if (!running) return;
            
            // Update ecological dynamics (if enabled)
            updateEcologicalDynamics();
            
            // Clear canvas
            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Update and draw agents
            agents.forEach(agent => {
                agent.update();
                agent.draw();
            });
            
            // Reproduction and death
            if (time % 20 === 0) {
                reproduce();
                removeDead();
            }
            
            // Update metrics
            updateMetrics();
            updateEcologicalDisplay();
            updatePhase();
            
            // Draw timeline
            if (time % 5 === 0) {
                drawTimeline();
            }
            
            time++;
            requestAnimationFrame(animate);
        }
        
        // Event listeners
        document.getElementById('startBtn').addEventListener('click', () => {
            running = true;
            animate();
        });
        
        document.getElementById('pauseBtn').addEventListener('click', () => {
            running = false;
        });
        
        document.getElementById('resetBtn').addEventListener('click', () => {
            running = false;
            init();
            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            agents.forEach(a => a.draw());
            updateMetrics();
            updateEcologicalDisplay();
            drawTimeline();
        });
        
        document.getElementById('interventionBtn').addEventListener('click', () => {
            // Apply intervention: reduce symbolic complexity
            // Friction will naturally INCREASE as complexity decreases (it's calculated!)
            params.symbolicComplexity = Math.max(1.0, params.symbolicComplexity * 0.5);
            document.getElementById('symbolicSlider').value = params.symbolicComplexity * 10;
            document.getElementById('symbolicValue').textContent = params.symbolicComplexity.toFixed(1) + 'x';
            updateSliderEffects(); // This updates the friction display
            updateSystemDiagnosis();
        });
        
        // System diagnosis function
        function updateSystemDiagnosis() {
            const diagnosis = [];
            let overallRisk = 'low';
            let riskColor = 'text-green-400';
            
            // Analyze symbolic complexity
            if (params.symbolicComplexity < 1.5) {
                diagnosis.push({
                    icon: '‚úì',
                    color: 'text-green-400',
                    text: 'Low symbolic complexity: Social structures remain grounded in biological needs'
                });
            } else if (params.symbolicComplexity < 3.0) {
                diagnosis.push({
                    icon: '‚ö†',
                    color: 'text-yellow-400',
                    text: 'Moderate complexity: Some stress but manageable with sufficient friction'
                });
                overallRisk = 'medium';
            } else if (params.symbolicComplexity < 5.0) {
                diagnosis.push({
                    icon: '‚ö†',
                    color: 'text-orange-400',
                    text: 'High complexity: Symbolic hierarchies starting to decouple from reality'
                });
                overallRisk = 'high';
            } else {
                diagnosis.push({
                    icon: '‚úó',
                    color: 'text-red-400',
                    text: 'Extreme complexity: Behavioral sink likely - symbolic structures completely ungrounded'
                });
                overallRisk = 'critical';
            }
            
            // Analyze environmental friction (NOW EMERGENT from complexity + abundance)
            const calculatedFriction = getEffectiveFriction();
            if (calculatedFriction > 0.6) {
                diagnosis.push({
                    icon: '‚úì',
                    color: 'text-green-400',
                    text: 'High friction: Low abstraction maintains physical grounding'
                });
            } else if (calculatedFriction > 0.3) {
                diagnosis.push({
                    icon: '‚ö†',
                    color: 'text-yellow-400',
                    text: 'Moderate friction: Abstraction enabling some friction reduction'
                });
                if (overallRisk === 'low') overallRisk = 'medium';
            } else {
                diagnosis.push({
                    icon: '‚úó',
                    color: 'text-red-400',
                    text: 'Low friction: High abstraction + abundance ‚Üí frictionless environment'
                });
                overallRisk = 'critical';
            }
            
            // Analyze resource abundance
            if (params.resourceAbundance >= 90 && params.resourceAbundance <= 130) {
                diagnosis.push({
                    icon: '‚úì',
                    color: 'text-green-400',
                    text: 'Balanced resources: Adequate supply without masking dysfunction'
                });
            } else if (params.resourceAbundance < 90) {
                diagnosis.push({
                    icon: '‚ö†',
                    color: 'text-orange-400',
                    text: 'Resource scarcity: Health recovery slower, stress from competition'
                });
                if (overallRisk === 'low') overallRisk = 'medium';
            } else {
                diagnosis.push({
                    icon: '‚ö†',
                    color: 'text-yellow-400',
                    text: 'Resource excess: Abundance masks underlying pathology, delays natural correction'
                });
            }
            
            // Analyze population density - NOTE: Density is NOT a primary cause!
            // This diagnosis is informational, not predictive of collapse
            // Use ACTUAL density (agents.length), not initial population
            const actualDensity = getActualDensity();
            if (actualDensity < 0.13) {
                diagnosis.push({
                    icon: '‚Ñπ',
                    color: 'text-blue-400',
                    text: `Low density (${actualDensity.toFixed(2)}/1000px¬≤): Comfortable spacing (density is NOT the key factor)`
                });
            } else if (actualDensity < 0.22) {
                diagnosis.push({
                    icon: '‚Ñπ',
                    color: 'text-blue-400',
                    text: `Moderate density (${actualDensity.toFixed(2)}/1000px¬≤): More contact, stable if complexity low`
                });
            } else {
                diagnosis.push({
                    icon: '‚Ñπ',
                    color: 'text-blue-400',
                    text: `High density (${actualDensity.toFixed(2)}/1000px¬≤): Can still thrive with simple structures`
                });
            }
            
            // THE KEY DIAGNOSTIC: Symbolic complexity / friction ratio
            // This is what actually determines behavioral sink, NOT density
            const symbolicDecoupling = Math.max(0, params.symbolicComplexity - 1.5);
            const decouplingRatio = symbolicDecoupling / (0.5 + calculatedFriction);
            
            if (decouplingRatio > 5) {
                diagnosis.push({
                    icon: 'üö®',
                    color: 'text-red-400',
                    text: 'BEHAVIORAL SINK: Symbolic structures completely decoupled from biological reality'
                });
                overallRisk = 'critical';
            } else if (decouplingRatio > 3) {
                diagnosis.push({
                    icon: '‚ö†',
                    color: 'text-orange-400',
                    text: 'DANGER: High symbolic decoupling - reproduction declining'
                });
                if (overallRisk !== 'critical') overallRisk = 'high';
            } else if (decouplingRatio > 1.5) {
                diagnosis.push({
                    icon: '‚ö†',
                    color: 'text-yellow-400',
                    text: 'STRESS: Moderate decoupling - friction partially compensating'
                });
                if (overallRisk === 'low') overallRisk = 'medium';
            } else {
                diagnosis.push({
                    icon: '‚úì',
                    color: 'text-green-400',
                    text: 'GROUNDED: Symbolic structures aligned with biological needs'
                });
            }
            
            // Overall prognosis
            let prognosis = '';
            if (overallRisk === 'low') {
                riskColor = 'text-green-400';
                prognosis = 'üéØ SUSTAINABLE: Population should stabilize and thrive';
            } else if (overallRisk === 'medium') {
                riskColor = 'text-yellow-400';
                prognosis = '‚ö† SURVIVABLE: Chronic stress but population can persist';
            } else if (overallRisk === 'high') {
                riskColor = 'text-orange-400';
                prognosis = '‚ö† PATHOLOGICAL: Reproductive decline likely, intervention needed';
            } else {
                riskColor = 'text-red-400';
                prognosis = '‚úó COLLAPSE: Behavioral sink trajectory - population extinction probable';
            }
            
            // Render diagnosis
            const diagnosisDiv = document.getElementById('systemDiagnosis');
            diagnosisDiv.innerHTML = `
                <div class="p-3 mb-3 rounded-lg border-2 ${riskColor.replace('text-', 'border-')} bg-black/30">
                    <div class="font-bold ${riskColor}">${prognosis}</div>
                </div>
                ${diagnosis.map(d => `
                    <div class="flex gap-2">
                        <span class="${d.color}">${d.icon}</span>
                        <span class="text-gray-300">${d.text}</span>
                    </div>
                `).join('')}
            `;
        }
        
        // Update slider effect explanations
        function updateSliderEffects() {
            // Initial population slider - actual density shown in metrics
            const initPop = params.initialPopulation;
            let densityText = `Starting with ${initPop} agents. Actual density updates in real-time above.`;
            document.getElementById('densityEffect').textContent = densityText;
            
            // Resource effects - interact with complexity!
            const resources = params.resourceAbundance;
            const complexity = params.symbolicComplexity;
            let resourceText = '';
            if (resources < 70) {
                if (complexity < 2) {
                    resourceText = 'üîµ SCARCITY FELT: Low reproduction, stress (natural ecological response)';
                } else {
                    resourceText = '‚ö†Ô∏è SCARCITY HIDDEN: High complexity masks reality until crisis';
                }
            } else if (resources < 90) {
                resourceText = 'üíõ LIMITED: Moderate stress, reality partially felt';
            } else if (resources <= 130) {
                resourceText = 'üíö BALANCED: Optimal for sustainable population';
            } else {
                if (complexity < 2) {
                    resourceText = 'üíö ABUNDANT: Thriving population (reality still grounded)';
                } else {
                    resourceText = '‚ö†Ô∏è EXCESS: Abundance + complexity = "unlimited resource" illusion';
                }
            }
            document.getElementById('resourceEffect').textContent = resourceText;
            
            // Symbolic complexity effects - THE KEY VARIABLE
            let complexityText = '';
            if (complexity < 2.0) {
                complexityText = 'üíö LOW: Reality clearly felt, ecological feedback works';
            } else if (complexity < 3.5) {
                complexityText = 'üíõ MODERATE: Some abstraction, reality partially obscured';
            } else if (complexity < 5.0) {
                complexityText = 'üß° HIGH: Status competition replacing biological drives';
            } else if (complexity < 7.0) {
                complexityText = '‚ù§Ô∏è SEVERE: Brain can\'t distinguish real vs symbolic rewards';
            } else {
                complexityText = 'üö® EXTREME: Complete decoupling ‚Üí behavioral sink imminent';
            }
            document.getElementById('symbolicEffect').textContent = complexityText;
            
            // Friction effects - NOW CALCULATED from complexity + abundance
            const friction = getEffectiveFriction();
            
            // Update the friction display value and progress bar
            document.getElementById('frictionValue').textContent = friction.toFixed(2);
            const frictionPercent = friction * 100;
            const frictionBar = document.getElementById('frictionBar');
            if (frictionBar) {
                frictionBar.style.width = frictionPercent + '%';
                // Color based on level
                if (friction < 0.3) {
                    frictionBar.className = 'h-2 rounded transition-all bg-red-500';
                } else if (friction < 0.5) {
                    frictionBar.className = 'h-2 rounded transition-all bg-yellow-500';
                } else {
                    frictionBar.className = 'h-2 rounded transition-all bg-green-500';
                }
            }
            
            let frictionText = '';
            if (friction < 0.2) {
                frictionText = 'üö® FRICTIONLESS: High abstraction + abundance ‚Üí no feedback loops';
            } else if (friction < 0.4) {
                frictionText = '‚ù§Ô∏è LOW: Abstraction enables low friction floor';
            } else if (friction < 0.65) {
                frictionText = 'üíõ MODERATE: Some physical constraints remain';
            } else {
                frictionText = 'üíö HIGH: Low abstraction = unavoidable physical friction';
            }
            document.getElementById('frictionEffect').textContent = frictionText;
        }
        
        // Parameter sliders with live diagnosis
        document.getElementById('densitySlider').addEventListener('input', (e) => {
            params.initialPopulation = parseInt(e.target.value);
            document.getElementById('densityValue').textContent = params.initialPopulation;
            updateSliderEffects();
            updateSystemDiagnosis();
        });
        
        document.getElementById('resourceSlider').addEventListener('input', (e) => {
            params.resourceAbundance = parseInt(e.target.value);
            document.getElementById('resourceValue').textContent = params.resourceAbundance + '%';
            updateSliderEffects();
            updateSystemDiagnosis();
        });
        
        document.getElementById('symbolicSlider').addEventListener('input', (e) => {
            params.symbolicComplexity = parseInt(e.target.value) / 10;
            document.getElementById('symbolicValue').textContent = params.symbolicComplexity.toFixed(1) + 'x';
            updateSliderEffects();
            updateSystemDiagnosis();
        });
        
        // Ecological Dynamics Toggle
        document.getElementById('ecologicalToggle').addEventListener('change', (e) => {
            params.enableEcologicalDynamics = e.target.checked;
            const ecologicalPanel = document.getElementById('ecologicalPanel');
            const ecologicalMetrics = document.getElementById('ecologicalMetrics');
            const resourceLabel = document.getElementById('resourceLabel');
            const resourceModeNote = document.getElementById('resourceModeNote');
            
            if (params.enableEcologicalDynamics) {
                ecologicalPanel.classList.remove('hidden');
                ecologicalMetrics.classList.remove('hidden');
                resourceModeNote.classList.remove('hidden');
                // Change label to reflect that this is now ACTUAL capacity
                resourceLabel.textContent = 'Ecological Carrying Capacity';
                resourceLabel.className = 'text-sm text-cyan-300 font-semibold';
                // Reset ecological state when enabling
                resetEcologicalState();
            } else {
                ecologicalPanel.classList.add('hidden');
                ecologicalMetrics.classList.add('hidden');
                resourceModeNote.classList.add('hidden');
                // Restore original label
                resourceLabel.textContent = 'Resource Abundance';
                resourceLabel.className = 'text-sm text-gray-300';
            }
            updateSystemDiagnosis();
        });
        
        // Reset ecological state to initial values
        function resetEcologicalState() {
            // In ecological mode, slider sets ACTUAL carrying capacity
            // Perceived starts there but is then driven by symbolic abstraction
            ecologicalState.actualAbundance = params.resourceAbundance;
            // Perceived also starts at actual, but will diverge based on abstraction
            ecologicalState.perceivedAbundance = params.resourceAbundance;
            ecologicalState.overshootFactor = 1.0;
            ecologicalState.regenerationCapacity = 100;
            ecologicalState.extractiveDebt = 0;
            ecologicalState.extractionRate = 0;
            ecologicalState.divergence = 0;
            ecologicalState.symbolIntegrity = 100;
            ecologicalState.collapsed = false;
            updateEcologicalDisplay();
        }
        
        // Update ecological metrics display
        function updateEcologicalDisplay() {
            if (!params.enableEcologicalDynamics) return;
            
            // Overshoot metric with color coding
            const overshoot = ecologicalState.overshootFactor;
            const overshootEl = document.getElementById('overshootMetric');
            const overshootExplain = document.getElementById('overshootExplain');
            overshootEl.textContent = overshoot.toFixed(2) + 'x';
            
            if (overshoot <= 1.0) {
                overshootEl.className = 'text-2xl font-bold text-green-400';
                overshootExplain.textContent = '‚úì Sustainable - extracting less than regeneration';
                overshootExplain.className = 'text-xs mt-1 text-green-400';
            } else if (overshoot <= 1.5) {
                overshootEl.className = 'text-2xl font-bold text-yellow-400';
                overshootExplain.textContent = '‚ö† Mild overshoot - depleting slowly';
                overshootExplain.className = 'text-xs mt-1 text-yellow-400';
            } else if (overshoot <= 2.0) {
                overshootEl.className = 'text-2xl font-bold text-orange-400';
                overshootExplain.textContent = '‚ö† Significant - damaging regeneration capacity';
                overshootExplain.className = 'text-xs mt-1 text-orange-400';
            } else {
                overshootEl.className = 'text-2xl font-bold text-red-400';
                overshootExplain.textContent = '‚ò† Critical - rapid depletion + permanent damage';
                overshootExplain.className = 'text-xs mt-1 text-red-400';
            }
            
            // Abundance bars
            const actualPct = Math.max(0, Math.min(100, ecologicalState.actualAbundance / 2));
            const perceivedPct = Math.max(0, Math.min(100, ecologicalState.perceivedAbundance / 2));
            
            document.getElementById('actualAbundanceValue').textContent = Math.round(ecologicalState.actualAbundance) + '%';
            document.getElementById('actualAbundanceBar').style.width = actualPct + '%';
            document.getElementById('perceivedAbundanceValue').textContent = Math.round(ecologicalState.perceivedAbundance) + '%';
            document.getElementById('perceivedAbundanceBar').style.width = perceivedPct + '%';
            
            // Regeneration capacity
            document.getElementById('regenCapacityValue').textContent = Math.round(ecologicalState.regenerationCapacity) + '%';
            document.getElementById('regenCapacityBar').style.width = ecologicalState.regenerationCapacity + '%';
            
            // Symbol integrity
            document.getElementById('symbolIntegrityValue').textContent = Math.round(ecologicalState.symbolIntegrity) + '%';
            document.getElementById('symbolIntegrityBar').style.width = ecologicalState.symbolIntegrity + '%';
            
            // Small metrics panel
            document.getElementById('perceivedAbundanceDisplay').textContent = Math.round(ecologicalState.perceivedAbundance) + '%';
            document.getElementById('actualAbundanceDisplay').textContent = Math.round(ecologicalState.actualAbundance) + '%';
            document.getElementById('divergenceDisplay').textContent = Math.round(ecologicalState.divergence);
            document.getElementById('extractiveDebtDisplay').textContent = ecologicalState.extractiveDebt.toFixed(1);
            document.getElementById('symbolIntegrityDisplay').textContent = Math.round(ecologicalState.symbolIntegrity) + '%';
            document.getElementById('regenCapacityDisplay').textContent = Math.round(ecologicalState.regenerationCapacity) + '%';
            
            // Collapse warning
            const collapseWarning = document.getElementById('collapseWarning');
            if (ecologicalState.collapsed) {
                collapseWarning.classList.remove('hidden');
            } else {
                collapseWarning.classList.add('hidden');
            }
            
            // Ecological diagnosis - now includes debt
            const diagEl = document.getElementById('ecologicalDiagnosis');
            let diagnosis = '';
            
            if (ecologicalState.collapsed) {
                diagnosis = '<span class="text-red-400 font-bold">‚ò† TERMINAL COLLAPSE</span><br>Symbols have failed. Extractive debt released as destruction. Only physical reality remains.';
            } else if (ecologicalState.extractiveDebt > 70) {
                diagnosis = '<span class="text-red-400">‚ö† Debt Crisis</span><br>Extractive debt critical (' + ecologicalState.extractiveDebt.toFixed(0) + '). Correction imminent regardless of symbol integrity.';
            } else if (ecologicalState.symbolIntegrity < 30) {
                diagnosis = '<span class="text-red-400">‚ö† Symbol Failure Imminent</span><br>Symbols collapsing. Debt: ' + ecologicalState.extractiveDebt.toFixed(0) + '. Perceived crashing toward actual.';
            } else if (ecologicalState.extractiveDebt > 40) {
                diagnosis = '<span class="text-orange-400">‚ö† Insanity Bubble</span><br>Extractive debt building (' + ecologicalState.extractiveDebt.toFixed(0) + '). Divergence: ' + Math.round(ecologicalState.divergence) + '. Spring tension rising.';
            } else if (ecologicalState.regenerationCapacity < 50) {
                diagnosis = '<span class="text-orange-400">‚ö† Ecological Damage</span><br>Regeneration capacity permanently impaired (' + Math.round(ecologicalState.regenerationCapacity) + '%). Recovery increasingly difficult.';
            } else if (overshoot > 1.7) {
                diagnosis = '<span class="text-yellow-400">Earth Overshoot</span><br>Consuming at ' + overshoot.toFixed(1) + 'x regeneration. Debt accumulating: ' + ecologicalState.extractiveDebt.toFixed(1);
            } else if (ecologicalState.extractiveDebt > 10) {
                diagnosis = '<span class="text-yellow-400">Recovering</span><br>Below sustainable extraction. Paying down debt: ' + ecologicalState.extractiveDebt.toFixed(1);
            } else {
                diagnosis = '<span class="text-green-400">Ecological Balance</span><br>Extraction within regeneration. Debt: ' + ecologicalState.extractiveDebt.toFixed(1) + '. System sustainable.';
            }
            
            diagEl.innerHTML = diagnosis;
        }
        
        // Friction slider REMOVED - friction is now CALCULATED from complexity + abundance
        // High abstraction ENABLES low friction (this is the key insight!)
        
        // Scenario presets - friction is EMERGENT from abstraction + abundance
        function loadScenario(scenario) {
            const scenarios = {
                'sustainable': {
                    initialPopulation: 60,
                    resourceAbundance: 110,
                    symbolicComplexity: 1.3,
                    // Low abstraction = high friction floor (unavoidable)
                    description: 'SUSTAINABLE: Low abstraction ‚Üí friction floor high ‚Üí stable thriving population'
                },
                'scarcity-grounded': {
                    initialPopulation: 50,
                    resourceAbundance: 60,
                    symbolicComplexity: 1.2,
                    // Low abstraction + scarcity = very high friction (physical reality dominant)
                    description: 'HEALTHY SCARCITY: Low abstraction means scarcity is physically UNAVOIDABLE ‚Üí natural response'
                },
                'crowded-stable': {
                    initialPopulation: 150,
                    resourceAbundance: 100,
                    symbolicComplexity: 1.4,
                    // Low abstraction = high friction floor, regardless of density
                    description: 'CROWDED BUT STABLE: Low abstraction = high friction floor ‚Üí density irrelevant!'
                },
                'modern': {
                    initialPopulation: 80,
                    resourceAbundance: 120,
                    symbolicComplexity: 3.5,
                    // Moderate abstraction lowers friction floor + abundance exploits it
                    description: 'MODERN SOCIETY: Moderate abstraction lowers friction floor ‚Üí chronic stress'
                },
                'calhoun': {
                    initialPopulation: 100,
                    resourceAbundance: 200,
                    symbolicComplexity: 6.0,
                    // High abstraction = very low friction floor + unlimited resources exploits fully
                    description: 'UNIVERSE 25: High abstraction = low friction floor + abundance ‚Üí frictionless ‚Üí sink'
                },
                'sparse-collapse': {
                    initialPopulation: 30,
                    resourceAbundance: 150,
                    symbolicComplexity: 7.0,
                    // Very high abstraction = near-zero friction floor
                    description: 'SPARSE BUT COLLAPSING: Abstraction enables frictionless ‚Üí collapse (NOT density!)'
                },
                'social-media': {
                    initialPopulation: 80,
                    resourceAbundance: 150,
                    symbolicComplexity: 8.0,
                    // Extreme abstraction = friction floor approaches zero
                    description: 'DIGITAL DYSTOPIA: Extreme abstraction ‚Üí friction floor ~0 ‚Üí rapid sink'
                },
                'insanity-bubble': {
                    initialPopulation: 100,
                    resourceAbundance: 180,  // High PERCEIVED abundance
                    symbolicComplexity: 7.0,
                    enableEcologicalDynamics: true,  // This scenario REQUIRES ecological mode
                    // The full lifecycle: perceived diverges from actual ‚Üí overshoot ‚Üí symbol collapse ‚Üí extinction
                    description: 'INSANITY BUBBLE: Perceived abundance maintained by symbols while actual depletes ‚Üí terminal collapse'
                }
            };
            
            if (scenarios[scenario]) {
                // Copy scenario params (friction is calculated, not stored)
                params.initialPopulation = scenarios[scenario].initialPopulation;
                params.resourceAbundance = scenarios[scenario].resourceAbundance;
                params.symbolicComplexity = scenarios[scenario].symbolicComplexity;
                
                // Handle ecological dynamics toggle for scenarios
                if (scenarios[scenario].enableEcologicalDynamics !== undefined) {
                    params.enableEcologicalDynamics = scenarios[scenario].enableEcologicalDynamics;
                    document.getElementById('ecologicalToggle').checked = params.enableEcologicalDynamics;
                    
                    const ecologicalPanel = document.getElementById('ecologicalPanel');
                    const ecologicalMetrics = document.getElementById('ecologicalMetrics');
                    
                    if (params.enableEcologicalDynamics) {
                        ecologicalPanel.classList.remove('hidden');
                        ecologicalMetrics.classList.remove('hidden');
                        resetEcologicalState();
                    } else {
                        ecologicalPanel.classList.add('hidden');
                        ecologicalMetrics.classList.add('hidden');
                    }
                }
                
                // Update sliders (friction is calculated, not a slider)
                document.getElementById('densitySlider').value = params.initialPopulation;
                document.getElementById('resourceSlider').value = params.resourceAbundance;
                document.getElementById('symbolicSlider').value = params.symbolicComplexity * 10;
                document.getElementById('densityValue').textContent = params.initialPopulation;
                document.getElementById('resourceValue').textContent = params.resourceAbundance + '%';
                document.getElementById('symbolicValue').textContent = params.symbolicComplexity.toFixed(1) + 'x';
                
                init();
                if (running) {
                    animate();
                } else {
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    agents.forEach(a => a.draw());
                }
                updateSliderEffects(); // This calculates and displays friction
                updateSystemDiagnosis();
            }
        }
        
        // Phase information
        const phaseDescriptions = [
            {
                phase: 1,
                title: 'Phase 1: Equilibrium',
                description: 'Population stable, reproduction healthy, low pathology. Symbolic structures aligned with biological needs.',
                color: 'border-green-500'
            },
            {
                phase: 2,
                title: 'Phase 2: Symbolic Overload',
                description: 'Density increasing, symbolic complexity rising. Stress levels climb as social structures become more complex.',
                color: 'border-yellow-500'
            },
            {
                phase: 3,
                title: 'Phase 3: Pathological Emergence',
                description: 'Reproductive health declining, violence and withdrawal appearing. Symbolic structures decoupling from reality.',
                color: 'border-orange-500'
            },
            {
                phase: 4,
                title: 'Phase 4: Behavioral Sink Collapse',
                description: 'Population collapse imminent. Widespread pathology: reproductive failure, violence, social withdrawal. System failure.',
                color: 'border-red-500'
            }
        ];
        
        const phaseInfo = document.getElementById('phaseInfo');
        phaseDescriptions.forEach(p => {
            const div = document.createElement('div');
            div.className = `p-3 bg-black/30 rounded-lg border-l-4 ${p.color}`;
            div.innerHTML = `
                <div class="font-semibold mb-1">${p.title}</div>
                <div class="text-sm text-gray-300">${p.description}</div>
            `;
            phaseInfo.appendChild(div);
        });
        
        // Initialize
        init();
        ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        agents.forEach(a => a.draw());
        updateMetrics();
        updateSliderEffects();
        updateSystemDiagnosis();
    </script>
</body>
</html>